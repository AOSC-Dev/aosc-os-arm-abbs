From c52c7bace3a8a4e53baa008d05df8aee75733eee Mon Sep 17 00:00:00 2001
From: pancake <pancake@nopcode.org>
Date: Mon, 11 Jun 2018 03:36:45 +0200
Subject: [PATCH] Fix #10300 - Link issues --with-sysmagic

---
 binr/radare2/Makefile | 1 +
 libr/bin/Makefile     | 1 +
 libr/magic/Makefile   | 5 ++---
 libr/magic/deps.mk    | 4 ++++
 libr/magic/magic.c    | 4 ++--
 5 files changed, 10 insertions(+), 5 deletions(-)
 create mode 100644 libr/magic/deps.mk

diff --git a/binr/radare2/Makefile b/binr/radare2/Makefile
index 2d06548881..2d8f59357f 100644
--- a/binr/radare2/Makefile
+++ b/binr/radare2/Makefile
@@ -73,6 +73,7 @@ LDFLAGS+=${DL_LIBS} -lm
 endif
 
 include ../../libr/socket/deps.mk
+include ../../libr/magic/deps.mk
 include ../../shlr/zip/deps.mk
 include ../../shlr/gdb/deps.mk
 include ../../shlr/java/deps.mk
diff --git a/libr/bin/Makefile b/libr/bin/Makefile
index b4dc277fda..468333ad48 100644
--- a/libr/bin/Makefile
+++ b/libr/bin/Makefile
@@ -17,6 +17,7 @@ include ${STATIC_BIN_XTR_PLUGINS}
 include ${STATIC_BIN_LDR_PLUGINS}
 include $(SHLR)/java/deps.mk
 include $(SHLR)/ar/deps.mk
+include $(LIBR)/magic/deps.mk
 
 STATIC_OBJS=$(addprefix $(LTOP)/bin/p/, $(STATIC_OBJ))
 OBJS=bin.o dbginfo.o bin_ldr.o bin_write.o demangle.o dwarf.o filter.o file.o obj.o open.o
diff --git a/libr/magic/Makefile b/libr/magic/Makefile
index 6dab1cb169..64b318a1e3 100644
--- a/libr/magic/Makefile
+++ b/libr/magic/Makefile
@@ -5,11 +5,10 @@ NAME=r_magic
 DEPS=r_util
 PCLIBS=@LIBMAGIC@
 CFLAGS+=-I.
-ifeq (${USE_LIB_MAGIC},1)
-LDFLAGS+=-lmagic
-endif
 OBJS=apprentice.o ascmagic.o fsmagic.o funcs.o is_tar.o magic.o softmagic.o
 
+include deps.mk
+
 include $(LTOP)/rules.mk
 
 libfile.a:
diff --git a/libr/magic/deps.mk b/libr/magic/deps.mk
new file mode 100644
index 0000000000..aa86ed37b4
--- /dev/null
+++ b/libr/magic/deps.mk
@@ -0,0 +1,4 @@
+ifeq (${USE_LIB_MAGIC},1)
+LDFLAGS+=-lmagic
+endif
+
diff --git a/libr/magic/magic.c b/libr/magic/magic.c
index 2aa9b951f6..316a737d50 100644
--- a/libr/magic/magic.c
+++ b/libr/magic/magic.c
@@ -39,14 +39,14 @@
 #define MAXPATHLEN 255
 #endif
 
+R_LIB_VERSION (r_magic);
+
 #if USE_LIB_MAGIC
 #include <magic.h>
 #define RMagic void
 #undef R_API
 #define R_API
 
-R_LIB_VERSION (r_magic);
-
 R_API RMagic* r_magic_new(int flags) {
 	return magic_open (flags);
 }
