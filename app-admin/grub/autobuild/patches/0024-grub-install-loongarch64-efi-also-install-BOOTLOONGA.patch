From d11dd08454cb78cb866f7ec4f5c1891e3eb5c0ea Mon Sep 17 00:00:00 2001
From: Mingcong Bai <jeffbai@aosc.io>
Date: Fri, 9 Aug 2024 14:45:18 +0800
Subject: [PATCH 24/24] grub-install: (loongarch64-efi) also install
 BOOTLOONGARCH.EFI

Some old-world firmware (especially that of the BPI01000 revision) does not
recognise the standardised BOOTLOONGARCH64.EFI and only sees BOOTLOONGARCH.EFI
as the removable image name. Make a copy (since it is FAT/VFAT) to satisfy
both old- and new-world firmware.
---
 util/grub-install.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/util/grub-install.c b/util/grub-install.c
index c5eef8ac6..803101889 100644
--- a/util/grub-install.c
+++ b/util/grub-install.c
@@ -849,6 +849,7 @@ main (int argc, char *argv[])
   int is_efi = 0;
   const char *efi_distributor = NULL;
   const char *efi_file = NULL;
+  const char *efi_file_ow = NULL;
   char **grub_devices;
   grub_fs_t grub_fs;
   grub_device_t grub_dev = NULL;
@@ -1176,6 +1177,7 @@ main (int argc, char *argv[])
 	      break;
 	    case GRUB_INSTALL_PLATFORM_LOONGARCH64_EFI:
 	      efi_file = "BOOTLOONGARCH64.EFI";
+	      efi_file_ow = "BOOTLOONGARCH.EFI";
 	      break;
 	    case GRUB_INSTALL_PLATFORM_RISCV32_EFI:
 	      efi_file = "BOOTRISCV32.EFI";
@@ -1212,6 +1214,7 @@ main (int argc, char *argv[])
 	      break;
 	    case GRUB_INSTALL_PLATFORM_LOONGARCH64_EFI:
 	      efi_file = "grubloongarch64.efi";
+	      efi_file_ow = "grubloongarch.efi";
 	      break;
 	    case GRUB_INSTALL_PLATFORM_RISCV32_EFI:
 	      efi_file = "grubriscv32.efi";
@@ -1989,6 +1992,11 @@ main (int argc, char *argv[])
 	char *dst = grub_util_path_concat (2, efidir, efi_file);
 	grub_install_copy_file (imgfile, dst, 1);
 
+	if (platform == GRUB_INSTALL_PLATFORM_LOONGARCH64_EFI) {
+	  char *dst_ow = grub_util_path_concat (2, efidir, efi_file_ow);
+	  grub_install_copy_file (dst, dst_ow, 1);
+	}
+
 	grub_set_install_backup_ponr ();
 
 	free (dst);
-- 
2.46.0

