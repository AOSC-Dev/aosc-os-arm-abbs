if [[ "${CROSS:-$ARCH}" = "amd64" || "${CROSS:-$ARCH}" = "arm64" ]]; then
    WIREDTIGER="--wiredtiger=on"
else
    WIREDTIGER="--wiredtiger=off"
fi

scons install-core \
	${MAKEFLAGS/ /} \
        --use-system-boost \
	--use-system-pcre \
	--use-system-snappy \
	--use-system-valgrind \
	--use-system-zlib \
	--use-system-yaml \
        --use-system-zstd \
        --use-system-tcmalloc \
	--ssl \
        --lto=on \
	--disable-warnings-as-errors --nostrip ${WIREDTIGER} \
	PREFIX=/usr DESTDIR="$PKGDIR"

install -dvm700 "$PKGDIR"/var/lib/mongodb
install -dvm755 "$PKGDIR"/var/log/mongodb

install -vd "$SRCDIR"/build/src/github.com/mongodb/bin
mv -v "$SRCDIR"/mongo-tools-r4.2.12 \
      "$SRCDIR"/build/src/github.com/mongodb/mongo-tools
sed -e 's/_Ctype_struct_/C.struct_/' \
    -i "$SRCDIR"/build/src/github.com/mongodb/mongo-tools/vendor/github.com/google/gopacket/pcap/pcap.go

cd "$SRCDIR"/build/src/github.com/mongodb/mongo-tools

GOROOT=/usr . ./set_goenv.sh
export GOPATH="$GOPATH:$SRCDIR/build"
export GO111MODULE=auto

mkdir -v bin
for i in bsondump mongostat mongofiles mongoexport mongoimport \
         mongorestore mongodump mongotop mongoreplay; do
    go build -buildmode=pie -o bin/$i -tags "ssl sasl" $i/main/$i.go
    install -Dvm755 bin/$i "$PKGDIR/usr/bin/$i"
done

abinfo "Removing text files from /usr ..."
rm -v "$PKGDIR/usr/"{LICENSE-Community.txt,MPL-2,README,THIRD-PARTY-NOTICES}
cd "$SRCDIR"
