mkdir -pv "$SRCDIR"/build
cd "$SRCDIR"/build

LLVM_VER="$(llvm-config --version)"
if [[ "${LLVM_VER%%.*}" != "${PKGVER%%.*}" ]]; then
    abdie "Please keep llvm-runtime+wasi ($PKGVER) in sync with system LLVM version ($LLVM_VER)!"
fi

abinfo "Running CMake for LLVM ..."
cmake "$SRCDIR" \
    ${CMAKE_DEF} ${CMAKE_AFTER} \
    -G Ninja

abinfo "Building & Installing LLVM to a temporary installation directory ..."
DESTDIR="$SRCDIR"/fakeroot \
    ninja install

abinfo "Installing runtime libraries ..."
install -vd "$PKGDIR"/usr/lib/wasm32-wasi/
cp -Pv \
    "$SRCDIR"/fakeroot/usr/* \
    "$PKGDIR"/usr/lib/wasm32-wasi/
