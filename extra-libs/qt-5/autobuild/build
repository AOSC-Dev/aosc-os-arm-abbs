abinfo "Aggregating a COMPLIST variable for later ..."
COMPLIST="`find "$SRCDIR" -maxdepth 1 -name 'qt*' -type d | cut -d'/' -f 2`"

if [[ "${CROSS:-$ARCH}" = "loongson3" || "${CROSS:-$ARCH}" = "ppc64el" ]]; then
    abinfo "FIXME: Skipping QtWebEngine on loongson3, ppc64el ..."
    NOMAKE="-skip qtwebengine"
fi

if [[ "${CROSS:-$ARCH}" = "amd64" ]]; then
    abinfo "Enabling use of SSE2 instructions on AMD64 ..."
    SSEOPT="-sse2"
fi

abinfo "Configuring Qt 5 ..."
"$SRCDIR"/configure \
        -verbose \
        -confirm-license \
        -opensource \
        -prefix /usr \
        -bindir /usr/lib/qt5/bin \
        -docdir /usr/share/doc/qt-5 \
        -headerdir /usr/include/qt5 \
        -archdatadir /usr/lib/qt5 \
        -datadir /usr/share/qt5 \
        -sysconfdir /etc/xdg \
        -examplesdir /usr/share/doc/qt-5/examples \
        -shared \
        -nomake tests \
        -no-rpath \
        -no-use-gold-linker \
        -no-reduce-relocations \
        -accessibility \
        -fontconfig \
        -system-ffmpeg \
        -system-harfbuzz \
        -system-libjpeg \
        -system-libpng \
        -system-sqlite \
        -system-pcre \
        -system-zlib \
        -plugin-sql-psql \
        -plugin-sql-sqlite \
        -plugin-sql-odbc \
        -openssl-linked \
        -dbus-linked \
        -optimized-qmake \
        -glib \
        -icu \
        -journald \
        -libinput \
        -libproxy \
        -feature-vulkan \
        -webengine-proprietary-codecs \
        -webengine-webp \
        -webengine-kerberos \
        -webengine-webrtc-pipewire \
        $NOMAKE $SSEOPT

abinfo "Building Qt 5 ..."
make V=1 VERBOSE=1

abinfo "Ensuring all Qt 5 components are built ..."
for i in $COMPLIST; do
    if [ -f ${i}/Makefile ]; then
        cd $i; make; cd "$SRCDIR"
    fi
done

abinfo "Installing Qt 5 ..."
make install INSTALL_ROOT="$PKGDIR"

abinfo "Ensuring all Qt 5 components are installed ..."
for i in $COMPLIST; do
    if [ -f ${i}/Makefile ]; then
        cd $i; make install INSTALL_ROOT="$PKGDIR" -j1; cd "$SRCDIR"
    fi
done

abinfo "Configuring QtWebKit ..."
QTWKSRCDIR="$SRCDIR"/../qtwebkit-${PKGVER:9: -12}-alpha4
PATCHDIR="$SRCDIR"/autobuild/patches
for p in "$PATCHDIR"/*.deferred; do
    patch -Np1 -i "$p" -d "$QTWKSRCDIR"
done
export Qt5_DIR="$PKGDIR"/usr

if [[ "${CROSS:-$ARCH}" != "amd64" && "${CROSS:-$ARCH}" != arm* ]]; then
    abinfo "FIXME: Disabling JIT on !x86, !arm ..."
    QTWKAFTER+=" -DENABLE_JIT=OFF"
else
    QTWKAFTER+=" -DENABLE_JIT=ON"
fi

abinfo "Creating directory for shadow build ..."
mkdir -pv "$QTWKSRCDIR"/abbuild
cd "$QTWKSRCDIR"/abbuild
(
    cmake "$QTWKSRCDIR" \
        -GNinja \
        ${CMAKE_DEF} ${QTWKAFTER} \
        -DPORT=Qt \
        -DQt5_DIR="$PKGDIR"/usr/lib/cmake/Qt5 \
        -DECM_MKSPECS_INSTALL_DIR=lib/qt5/mkspecs/modules \
        -DENABLE_TOOLS=OFF
    abinfo "Appending -latomic linkage to build.ninja ..."
    sed -e '/LINK_LIBRARIES = / s/$/ -latomic/' \
        -i "$QTWKSRCDIR"/abbuild/build.ninja
    abinfo "Building and installing QtWebKit binaries ..."
    DESTDIR="$PKGDIR" ninja install
)
