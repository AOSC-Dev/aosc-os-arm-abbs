Description: Do not crash when ncbytes is larger than the buffer size
Origin: vendor
Bug-Debian: https://bugs.debian.org/887776
Bug-Debian-Security: https://security-tracker.debian.org/tracker/CVE-2018-5345
Forwarded: not-needed
Author: Richard Hughes <richard@hughsie.com>
Reviewed-by: Salvatore Bonaccorso <carnil@debian.org>
Last-Update: 2018-01-19

---
 libgcab/cabinet.c               |  28 ++++++++++++++++++++++++----
 tests/test-ncbytes-overflow.cab | Bin 0 -> 95066 bytes
 2 files changed, 24 insertions(+), 4 deletions(-)
 create mode 100644 tests/test-ncbytes-overflow.cab

--- a/libgcab/cabinet.c
+++ b/libgcab/cabinet.c
@@ -459,18 +459,38 @@ cdata_read (cdata_t *cd, u1 res_data, gi
     gboolean success = FALSE;
     int ret, zret = Z_OK;
     gint compression = comptype & GCAB_COMPRESSION_MASK;
-    guint8 *buf = compression == GCAB_COMPRESSION_NONE ? cd->out : cd->in;
+    gsize buf_sz;
+    guint8 *buf = NULL;
     CHECKSUM datacsum;
 
-    if (compression > GCAB_COMPRESSION_MSZIP &&
-        compression != GCAB_COMPRESSION_LZX) {
+    /* decompress directly into ->out for no decompression */
+    switch (compression) {
+    case GCAB_COMPRESSION_NONE:
+        buf = cd->out;
+        buf_sz = sizeof(cd->out);
+        break;
+    case GCAB_COMPRESSION_MSZIP:
+    case GCAB_COMPRESSION_LZX:
+        buf = cd->in;
+        buf_sz = sizeof(cd->in);
+        break;
+    default:
         g_set_error (error, GCAB_ERROR, GCAB_ERROR_FAILED,
                      _("unsupported compression method %d"), compression);
-        return FALSE;
+        break;
     }
+    if (buf == NULL)
+        return FALSE;
 
     R4 (cd->checksum);
     R2 (cd->ncbytes);
+    if (cd->ncbytes > buf_sz) {
+        g_set_error (error, GCAB_ERROR, GCAB_ERROR_FAILED,
+                     _("tried to decompress %" G_GUINT16_FORMAT " bytes "
+                     "into buffer of size %" G_GSIZE_FORMAT),
+                     cd->ncbytes, buf_sz);
+        return FALSE;
+    }
     R2 (cd->nubytes);
     cd->reserved = g_malloc (res_data);
     RN (cd->reserved, res_data);
