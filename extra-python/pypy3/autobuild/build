cd pypy/goal
if [[ "${CROSS:-$ARCH}" = "amd64" || \
      "${CROSS:-$ARCH}" = "armv7hf" ]]; then
    python2 ../../rpython/bin/rpython -Ojit --lto --profopt targetpypystandalone
else
    python2 ../../rpython/bin/rpython -Ojit targetpypystandalone
fi
cd ../..

abinfo "Installing files and creating symbolic links ..."
install -Dvm755 "$SRCDIR"/pypy/goal/pypy3.9-c "$PKGDIR"/usr/lib/pypy3/bin/pypy3.9-c
ln -vs /usr/lib/pypy3/bin/pypy3.9-c "$PKGDIR"/usr/lib/pypy3/bin/pypy3-c

install -Dvm755 pypy/goal/libpypy3.9-c.so "$PKGDIR"/usr/lib/pypy3/bin/libpypy3.9-c.so
ln -vs /usr/lib/pypy3/bin/libpypy3.9-c.so "$PKGDIR"/usr/lib/pypy3/bin/libpypy3-c.so

cp -vr include lib_pypy lib/pypy3.9/site-packages "$PKGDIR"/usr/lib/pypy3/
ln -vs /usr/lib/pypy3 "$PKGDIR"/usr/lib/pypy3.9

mkdir -vp "$PKGDIR"/usr/lib/pypy3/lib-python/
cp -vr lib-python/3 "$PKGDIR"/usr/lib/pypy3/lib-python/

mkdir -vp "$PKGDIR"/usr/bin
ln -vs /usr/lib/pypy3/bin/pypy3.9-c "$PKGDIR"/usr/bin/pypy3

for module in _curses syslog dbm sqlite3 _tkinter; do
    "$PKGDIR"/usr/lib/pypy3/bin/pypy3.9-c -c "import ${module}"
done
