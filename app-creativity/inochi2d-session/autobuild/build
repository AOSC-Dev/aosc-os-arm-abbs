if [[ "${CROSS:-$ARCH}" = loongson3 ]]; then
    EXTRA_FLAGS="-mabi=n64 -mcpu=mips64r2 --linker=gold"
elif [[ "${CROSS:-$ARCH}" = riscv64 ]]; then
    EXTRA_FLAGS="-Xcc=-latomic --linker=lld -mattr=+d -mabi=lp64d"
elif [[ "${CROSS:-$ARCH}" = loongarch64 ]]; then
    EXTRA_FLAGS="-g -gdwarf=5 --linker=bfd"
else
    EXTRA_FLAGS="-g -gdwarf=5 --linker=lld"
fi

if [[ "$NOLTO" != 1 ]]; then
    LTO_FLAGS="-flto=full --gcc=clang"
fi

export DFLAGS="${EXTRA_FLAGS} ${LTO_FLAGS} -L-O3 -L-Wl,-build-id=sha1"

abinfo "Registering D dependencies ..."
dub add-local /usr/src/i2d-imgui 0.8.0

abinfo "Generating version file ..."
cat > "$SRCDIR"/source/session/ver.d << EOF
module session.ver;
enum INS_VERSION = "v$PKGVER";
EOF

abinfo "Building inochi2d-session ..."
dub build -c linux-full --compiler=ldmd -n -b release --override-config=i2d-imgui/static_dynamicCRT --override-config=lumars/lua51-dynamic

abinfo "Installing inochi2d-session ..."
install -dv "$PKGDIR"/usr/bin/
install -Dvm755 "$SRCDIR"/out/inochi-session "$PKGDIR"/usr/bin/
