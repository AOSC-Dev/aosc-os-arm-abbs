OLDARCH=$ARCH
unset ARCH
cp -v autobuild/config .config &&

LOCALNAME=-aosc-main
version=4.0.5

make 
make INSTALL_MOD_PATH=`pwd`/abdist modules_install $ABMK &&
mkdir -p abdist/boot 
cp arch/x86/boot/bzImage abdist/boot/vmlinuz-aosc-main-$PKGVER &&
export ARCH=$OLDARCH 
rm -rf abdist/lib/firmware
ln -s ../extramodules abdist/lib/modules/$version$LOCALNAME/extramodules

OLDARCH=$ARCH
unset ARCH
mkdir -p debian
srctree=`pwd`
objtree=`pwd`
kernel_headers_dir=`pwd`/abdist
SRCARCH=x86
(cd $srctree; find . -name Makefile\* -o -name Kconfig\* -o -name \*.pl > "$objtree/debian/hdrsrcfiles")
(cd $srctree; find arch/$SRCARCH/include include scripts -type f >> "$objtree/debian/hdrsrcfiles")
(cd $objtree; find arch/$SRCARCH/include .config Module.symvers include scripts -type f >> "$objtree/debian/hdrobjfiles")
destdir=$kernel_headers_dir/usr/src/linux-headers-$version
mkdir -p "$destdir"
(cd $srctree; tar -c -f - -T "$objtree/debian/hdrsrcfiles") | (cd $destdir; tar -xf -)
(cd $objtree; tar -c -f - -T "$objtree/debian/hdrobjfiles") | (cd $destdir; tar -xf -)
rm -f "$objtree/debian/hdrsrcfiles" "$objtree/debian/hdrobjfiles"
export ARCH=$OLDARCH
rm -fr abdist/usr/src/linux-headers-${version}/abdist

rm -rf abdist/lib/modules/${version}${LOCALNAME}/{build,source}
ln -sfv /usr/src/linux-headers-$version abdist/lib/modules/${version}${LOCALNAME}/build
ln -sfv /usr/src/linux-headers-$version abdist/lib/modules/${version}${LOCALNAME}/source
