unset JAVA_HOME

install -d -m 755 `pwd`/image
sh configure \
    --prefix=`pwd`/image \
    --with-update-version=60 \
    --with-build-number=26 \
    --with-milestone="AOSC" \
    --enable-unlimited-crypto \
    --with-zlib=system \
    --with-boot-jdk=`pwd`/binary/openjdk-1.7.0-u80-unofficial-linux-amd64-image \
    CC=gcc CXX=g++

# FIXME: use system giflibwhen possible

make DEBUG_BINARIES=true                 \
     DISABLE_HOTSPOT_OS_VERSION_CHECK=ok \
     all
make docs

make install

pushd image/jvm/openjdk-1.8.0_60-AOSC
find . -iname '*.jar' -exec chmod ugo+r {} \;
chmod ugo+r lib/ct.sym

find . -iname '*.diz' -exec rm {} \;
find . -iname '*.debuginfo' -exec rm {} \;
popd

mkdir -p $PKGDIR/usr/lib/java
cp -r image/jvm/openjdk-1.8.0_60-AOSC/* $PKGDIR/usr/lib/java/

mv $PKGDIR/usr/lib/java/jre/lib/management/jmxremote.password{.template,}
mv $PKGDIR/usr/lib/java/jre/lib/management/snmp.acl{.template,}

for file in `cat autobuild/amd64/etcfiles`; do
    _filepkgpath=$PKGDIR/usr/lib/java/jre/lib/${file}
    install -D -m 644 ${_filepkgpath} $PKGDIR/etc/openjdk/${file}
done

mkdir -p $PKGDIR/usr/src/openjdk
install -D image/jvm/openjdk-1.8.0_60-AOSC/src.zip $PKGDIR/usr/src/openjdk/src.zip
ln -sv /usr/src/openjdk/src.zip $PKGDIR/usr/lib/java/src.zip

install -d -m 755 $PKGDIR/usr/share/doc/openjdk
cp -r build/linux-x86_64-normal-server-release/docs/* \
    $PKGDIR/usr/share/doc/openjdk/

mv $PKGDIR/usr/lib/java/man $PKGDIR/usr/share/man
ln -sv /usr/share/man $PKGDIR/usr/lib/java/man

cp -r $PKGDIR/usr/lib/java/jre/* $PKGDIR/usr/lib/java/
rm -r $PKGDIR/usr/lib/java/jre

pushd $PKGDIR/usr
mkdir bin
pushd bin
for i in ../lib/java/bin/*; do
    ln -sv $i
done
popd
popd

mkdir -p $PKGDIR/etc/ssl/certs/java
cp image/jvm/openjdk-1.8.0_60-AOSC/jre/lib/security/cacerts $PKGDIR/etc/ssl/certs/java/

rm -fv $PKGDIR/usr/lib/java/lib/security/cacerts
ln -sfv /etc/ssl/certs/java/cacerts $PKGDIR/usr/lib/java/lib/security/cacerts

pushd icedtea-web
./configure \
     --prefix=/usr/share/icedtea-web \
     --datarootdir=/usr/share \
     --with-jdk-home=/usr/lib/java \
     --with-jre-home=/usr/lib/java \
     --with-java=/usr/bin/java \
     --with-browser-tests \
     --with-firefox=/usr/bin/firefox \
     --with-epiphany=/usr/bin/epiphany \
     --disable-docs
make
make install DESTDIR=$PKGDIR
install -m 755 -d $PKGDIR/usr/share/{applications,pixmaps}
install -m 644 javaws.png $PKGDIR/usr/share/pixmaps
install -m 644 {javaws,itweb-settings}.desktop $PKGDIR/usr/share/applications
install -m 755 -d $PKGDIR/usr/lib/mozilla/plugins/
ln -sf /usr/share/icedtea-web/lib/IcedTeaPlugin.so $PKGDIR/usr/lib/mozilla/plugins/
for file in itweb-settings javaws policyeditor; do
    ln -sf /usr/share/icedtea-web/bin/${file} $PKGDIR/usr/bin/${file}
done
popd

# RPM is very, very confused by this.
rm -rf $PKGDIR/usr/share/man/ja
