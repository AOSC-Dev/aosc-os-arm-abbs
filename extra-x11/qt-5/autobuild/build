export QTDIR=$SRCDIR
export LD_LIBRARY_PATH="${QTDIR}/qt5base/lib:${QTDIR}/qt5tools/lib:${LD_LIBRARY_PATH}"
export QT_PLUGIN_PATH="${QTDIR}/qt5base/plugins"

./configure -confirm-license -opensource \
            -prefix /usr \
            -bindir /usr/lib/qt5/bin \
            -docdir /usr/share/doc/qt5 \
            -headerdir /usr/include/qt5 \
            -archdatadir /usr/lib/qt5 \
            -datadir /usr/share/qt5 \
            -sysconfdir /etc/xdg \
            -examplesdir /usr/share/doc/qt5/examples \
            -plugin-sql-psql \
            -plugin-sql-mysql \
            -plugin-sql-sqlite \
            -plugin-sql-odbc \
            -system-sqlite \
            -openssl-linked \
            -optimized-qmake \
            -dbus-linked \
            -nomake examples \
            -system-harfbuzz \
            -journald \
            -no-use-gold-linker \
            -reduce-relocations
make

sed -i "s|/usr/lib/qt5/bin/qdoc|${QTDIR}/qtbase/bin/qdoc|g" \
    "${QTDIR}"/qtbase/qmake/Makefile.qmake-docs
find "${QTDIR}" -name Makefile \
    -exec sed -i "s|/usr/lib/qt5/bin/qdoc|${QTDIR}/qtbase/bin/qdoc|g" {} +
sed -i "s|/usr/lib/qt5/bin/qhelpgenerator|${QTDIR}/qttools/bin/qhelpgenerator|g" \
    "${QTDIR}"/qtbase/qmake/Makefile.qmake-docs
find "${QTDIR}" -name Makefile \
    -exec sed -i "s|/usr/lib/qt5/bin/qhelpgenerator|${QTDIR}/qttools/bin/qhelpgenerator|g" {} +
sed -i "s|/usr/lib/qt5/bin/qhelpgenerator|${QTDIR}/qttools/bin/qhelpgenerator|g" \
    qtwebkit/Source/Makefile.api
find "${QTDIR}" -name Makefile \
    -exec sed -i "s|/usr/lib/qt5/bin/qmlplugindump|${QTDIR}/qtdeclarative/bin/qmlplugindump|g" {} +

make install INSTALL_ROOT=$PKGDIR

find $PKGDIR/usr/lib -type f -name '*.prl' \
    -exec sed -i -e '/^QMAKE_PRL_BUILD_DIR/d' {} \;
sed -i "s|$SRCDIR/qtbase|/usr|" \
    $PKGDIR/usr/lib/qt/mkspecs/modules/qt_lib_bootstrap_private.pri

perl -pi -e "s, -L${SRCDIR}/?\S+,,g" \
    $PKGDIR/usr/lib/pkgconfig/Qt5WebKit.pc
