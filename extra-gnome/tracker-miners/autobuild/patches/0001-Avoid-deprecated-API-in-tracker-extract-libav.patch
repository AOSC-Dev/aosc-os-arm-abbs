From be1637c3d4a6ea783df4daf8ffad7acc9684087e Mon Sep 17 00:00:00 2001
From: Pekka Vuorela <pekka.vuorela@jolla.com>
Date: Fri, 21 Jan 2022 14:08:05 +0200
Subject: [PATCH] Avoid deprecated API in tracker-extract-libav

---
 src/tracker-extract/tracker-extract-libav.c | 16 +++++++---------
 1 file changed, 7 insertions(+), 9 deletions(-)

diff --git a/src/tracker-extract/tracker-extract-libav.c b/src/tracker-extract/tracker-extract-libav.c
index b6bc4cfc3..d2d4baf6d 100644
--- a/src/tracker-extract/tracker-extract-libav.c
+++ b/src/tracker-extract/tracker-extract-libav.c
@@ -57,8 +57,6 @@ tracker_extract_get_metadata (TrackerExtractInfo  *info,
 	AVDictionaryEntry *tag = NULL;
 	const char *title = NULL;
 
-	av_register_all ();
-
 	file = tracker_extract_info_get_file (info);
 
 	uri = g_file_get_uri (file);
@@ -94,20 +92,20 @@ tracker_extract_get_metadata (TrackerExtractInfo  *info,
 	g_free (resource_uri);
 
 	if (audio_stream) {
-		if (audio_stream->codec->sample_rate > 0) {
-			tracker_resource_set_int64 (metadata, "nfo:sampleRate", audio_stream->codec->sample_rate);
+		if (audio_stream->codecpar->sample_rate > 0) {
+			tracker_resource_set_int64 (metadata, "nfo:sampleRate", audio_stream->codecpar->sample_rate);
 		}
-		if (audio_stream->codec->channels > 0) {
-			tracker_resource_set_int64 (metadata, "nfo:channels", audio_stream->codec->channels);
+		if (audio_stream->codecpar->channels > 0) {
+			tracker_resource_set_int64 (metadata, "nfo:channels", audio_stream->codecpar->channels);
 		}
 	}
 
 	if (video_stream && !(video_stream->disposition & AV_DISPOSITION_ATTACHED_PIC)) {
 		tracker_resource_add_uri(metadata, "rdf:type", "nmm:Video");
 
-		if (video_stream->codec->width > 0 && video_stream->codec->height > 0) {
-			tracker_resource_set_int64 (metadata, "nfo:width", video_stream->codec->width);
-			tracker_resource_set_int64 (metadata, "nfo:height", video_stream->codec->height);
+		if (video_stream->codecpar->width > 0 && video_stream->codecpar->height > 0) {
+			tracker_resource_set_int64 (metadata, "nfo:width", video_stream->codecpar->width);
+			tracker_resource_set_int64 (metadata, "nfo:height", video_stream->codecpar->height);
 		}
 
 		if (video_stream->avg_frame_rate.num > 0) {
-- 
2.36.0

