From e914c7d4b80f93f23fcf0f7b20600475b35145d4 Mon Sep 17 00:00:00 2001
From: xurui <xurui@kylinos.cn>
Date: Wed, 22 Mar 2023 17:08:58 +0800
Subject: [PATCH 090/105] modesetting: Check the return value of the
 drmGetVersion

Signed-off-by: xurui <xurui@kylinos.cn>
---
 hw/xfree86/drivers/modesetting/driver.c | 15 ++++++++++-----
 1 file changed, 10 insertions(+), 5 deletions(-)

diff --git a/hw/xfree86/drivers/modesetting/driver.c b/hw/xfree86/drivers/modesetting/driver.c
index c8542b89f..f9648522f 100644
--- a/hw/xfree86/drivers/modesetting/driver.c
+++ b/hw/xfree86/drivers/modesetting/driver.c
@@ -1100,16 +1100,21 @@ msShouldDoubleShadow(ScrnInfoPtr pScrn, modesettingPtr ms)
 {
     Bool ret = FALSE, asked;
     int from;
-    drmVersionPtr v = drmGetVersion(ms->fd);
+    drmVersionPtr v;
 
     if (!ms->drmmode.shadow_enable)
         return FALSE;
 
-    if (!strcmp(v->name, "mgag200") ||
-        !strcmp(v->name, "ast")) /* XXX || rn50 */
-        ret = TRUE;
+    if ((v = drmGetVersion(ms->fd))) {
+        if (!strcmp(v->name, "mgag200") ||
+            !strcmp(v->name, "ast")) /* XXX || rn50 */
+            ret = TRUE;
 
-    drmFreeVersion(v);
+        drmFreeVersion(v);
+    }
+    else
+        xf86DrvMsg(pScrn->scrnIndex, X_ERROR,
+                   "Failed to query DRM version.\n");
 
     asked = xf86GetOptValBool(ms->drmmode.Options, OPTION_DOUBLE_SHADOW, &ret);
 
-- 
2.45.2

