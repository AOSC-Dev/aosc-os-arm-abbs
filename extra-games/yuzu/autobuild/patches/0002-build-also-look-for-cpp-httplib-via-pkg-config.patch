From 71739b31241167f05a7623d6d4b6a06039d16065 Mon Sep 17 00:00:00 2001
From: Andrea Pappacoda <andrea@pappacoda.it>
Date: Fri, 25 Mar 2022 23:22:58 +0100
Subject: [PATCH 2/3] build: also look for cpp-httplib via pkg-config

---
 CMakeLists.txt                           |  6 ++----
 externals/CMakeLists.txt                 |  4 ++--
 externals/find-modules/Findhttplib.cmake | 22 ++++++++++++++++++++++
 src/web_service/CMakeLists.txt           |  2 +-
 4 files changed, 27 insertions(+), 7 deletions(-)
 create mode 100644 externals/find-modules/Findhttplib.cmake

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 722e181a8..026b86981 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -479,10 +479,8 @@ if (ARCHITECTURE_x86_64 AND NOT YUZU_USE_BUNDLED_DYNARMIC)
 endif()
 
 if (ENABLE_WEB_SERVICE AND NOT YUZU_USE_BUNDLED_HTTPLIB)
-    find_package(httplib)
-    if (httplib_FOUND)
-        add_library(httplib ALIAS httplib::httplib)
-    else()
+    find_package(httplib MODULE)
+    if (NOT httplib_FOUND)
         message(STATUS "httplib not found, falling back to externals")
         set(YUZU_USE_BUNDLED_HTTPLIB ON)
     endif()
diff --git a/externals/CMakeLists.txt b/externals/CMakeLists.txt
index a137ffe67..7b2f16c0b 100644
--- a/externals/CMakeLists.txt
+++ b/externals/CMakeLists.txt
@@ -95,7 +95,7 @@ endif()
 # Sirit
 add_subdirectory(sirit)
 
-if (ENABLE_WEB_SERVICE AND NOT TARGET httplib)
+if (ENABLE_WEB_SERVICE AND NOT TARGET httplib::httplib)
     find_package(OpenSSL 1.1)
     if (OPENSSL_FOUND)
         set(OPENSSL_LIBRARIES OpenSSL::SSL OpenSSL::Crypto)
@@ -119,7 +119,7 @@ if (ENABLE_WEB_SERVICE AND NOT TARGET httplib)
     if (WIN32)
         target_link_libraries(httplib INTERFACE crypt32 cryptui ws2_32)
     endif()
-	
+
     # cpp-jwt
     add_library(cpp-jwt INTERFACE)
     target_include_directories(cpp-jwt INTERFACE ./cpp-jwt/include)
diff --git a/externals/find-modules/Findhttplib.cmake b/externals/find-modules/Findhttplib.cmake
new file mode 100644
index 000000000..0c7374c21
--- /dev/null
+++ b/externals/find-modules/Findhttplib.cmake
@@ -0,0 +1,22 @@
+# SPDX-FileCopyrightText: 2022 Andrea Pappacoda <andrea@pappacoda.it>
+#
+# SPDX-License-Identifier: GPL-2.0-or-later
+
+find_package(httplib CONFIG)
+if (NOT httplib_FOUND)
+    find_package(PkgConfig QUIET)
+    if (PKG_CONFIG_FOUND)
+        pkg_search_module(cpp-httplib IMPORTED_TARGET cpp-httplib)
+        if (cpp-httplib_FOUND)
+            set(httplib_FOUND True)
+            set(HTTPLIB_VERSION "${cpp-httplib_VERSION}")
+            add_library(httplib::httplib ALIAS PkgConfig::cpp-httplib)
+        endif()
+    endif()
+endif()
+
+include(FindPackageHandleStandardArgs)
+find_package_handle_standard_args(httplib
+    REQUIRED_VARS httplib_FOUND
+    VERSION_VAR HTTPLIB_VERSION
+)
diff --git a/src/web_service/CMakeLists.txt b/src/web_service/CMakeLists.txt
index 3f75d97d1..cbd4a814e 100644
--- a/src/web_service/CMakeLists.txt
+++ b/src/web_service/CMakeLists.txt
@@ -16,4 +16,4 @@ add_library(web_service STATIC
 )
 
 create_target_directory_groups(web_service)
-target_link_libraries(web_service PRIVATE common network nlohmann_json::nlohmann_json httplib cpp-jwt)
+target_link_libraries(web_service PRIVATE common network nlohmann_json::nlohmann_json httplib::httplib cpp-jwt)
-- 
2.37.1

