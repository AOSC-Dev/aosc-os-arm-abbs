From 2dda30ca166da9838091eb17c9704455b16c1729 Mon Sep 17 00:00:00 2001
From: Feiyang Chen <chenfeiyang@loongson.cn>
Date: Tue, 5 Jul 2022 11:14:12 +0800
Subject: [PATCH v4 120/123] loongarch64: Update
 gdbserver_tests/filter_helgrind_monitor

---
 gdbserver_tests/Makefile.am                   |  1 +
 gdbserver_tests/filter_helgrind_monitor       |  2 +
 .../filter_helgrind_monitor_loongarch64       | 43 +++++++++++++++++++
 3 files changed, 46 insertions(+)
 create mode 100755 gdbserver_tests/filter_helgrind_monitor_loongarch64

diff --git a/gdbserver_tests/Makefile.am b/gdbserver_tests/Makefile.am
index fbcb6596d..30e17c0b9 100755
--- a/gdbserver_tests/Makefile.am
+++ b/gdbserver_tests/Makefile.am
@@ -15,6 +15,7 @@ dist_noinst_SCRIPTS = \
 	filter_gdb filter_make_empty \
 	filter_memcheck_monitor filter_stderr filter_vgdb \
 	filter_helgrind_monitor filter_helgrind_monitor_solaris \
+	filter_helgrind_monitor_loongarch64 \
 	filter_passsigalrm \
 	send_signal
 
diff --git a/gdbserver_tests/filter_helgrind_monitor b/gdbserver_tests/filter_helgrind_monitor
index 4fc2e9af6..21bf6be14 100755
--- a/gdbserver_tests/filter_helgrind_monitor
+++ b/gdbserver_tests/filter_helgrind_monitor
@@ -14,6 +14,8 @@ if $dir/../tests/os_test solaris; then
    $dir/filter_helgrind_monitor_solaris
 elif $dir/../tests/os_test freebsd; then
    gsed -e '/\(rtld_start.S\|kill.S\|_exit.S\|_select.S\): No such file or directory/d'
+elif $dir/../tests/arch_test loongarch64; then
+   $dir/filter_helgrind_monitor_loongarch64
 else
    cat
 fi |
diff --git a/gdbserver_tests/filter_helgrind_monitor_loongarch64 b/gdbserver_tests/filter_helgrind_monitor_loongarch64
new file mode 100755
index 000000000..cda73e4c2
--- /dev/null
+++ b/gdbserver_tests/filter_helgrind_monitor_loongarch64
@@ -0,0 +1,43 @@
+#!/usr/bin/env perl
+# From gdbserver_tests/filter_helgrind_monitor_solaris
+
+#
+# Filter out all helgrind information about locks except the one named "mx".
+# One lock record looks like:
+# Lock ga 0x........ {
+#  Address 0x........ is 2648 bytes inside data symbol "_rtld_local"
+#   kind   mbRec
+# }
+
+use strict;
+use warnings;
+
+my $lock_start_line = undef;
+my $skip_to_closing_line = 0;
+while (<STDIN>) {
+    my $line = $_;
+    chomp($line);
+    if ($line =~ /^Lock ga 0x[\.]+\s+{$/) {
+        $lock_start_line = $line;
+        $skip_to_closing_line = 1;
+    } elsif (($lock_start_line) &&
+             ($line =~ /\s*Address 0x[\.]+ is \d+ bytes inside data symbol "(\S+)"/)) {
+        if ($1 eq "mx") {
+           print "$lock_start_line\n";
+           print "$line\n";
+           $skip_to_closing_line = 0;
+        }
+    } elsif ($line =~ /^}$/) {
+        if ($skip_to_closing_line == 0) {
+            print "$line\n";
+        }
+        undef($lock_start_line);
+        $skip_to_closing_line = 0;
+    } else {
+        if ($skip_to_closing_line == 0) {
+            print "$line\n";
+        }
+    }
+}
+
+exit 0;
-- 
2.39.1

