From 701bf71f9b6490975a83da02d18ffe649399ad19 Mon Sep 17 00:00:00 2001
From: Feiyang Chen <chenfeiyang@loongson.cn>
Date: Tue, 22 Mar 2022 14:49:06 +0800
Subject: [PATCH v4 058/123] loongarch64: Add isel support for Iex_Load of
 integer expressions

---
 VEX/priv/host_loongarch64_isel.c | 28 ++++++++++++++++++++++++++--
 1 file changed, 26 insertions(+), 2 deletions(-)

diff --git a/VEX/priv/host_loongarch64_isel.c b/VEX/priv/host_loongarch64_isel.c
index 94f00e1ef..0382fd419 100644
--- a/VEX/priv/host_loongarch64_isel.c
+++ b/VEX/priv/host_loongarch64_isel.c
@@ -774,8 +774,32 @@ static HReg iselIntExpr_R_wrk ( ISelEnv* env, IRExpr* e )
          return lookupIRTemp(env, e->Iex.RdTmp.tmp);
 
       /* --------- LOAD --------- */
-      case Iex_Load:
-         break;
+      case Iex_Load: {
+         if (e->Iex.Load.end != Iend_LE)
+            goto irreducible;
+
+         LOONGARCH64AMode* am = iselIntExpr_AMode(env, e->Iex.Load.addr, ty);
+         HReg             dst = newVRegI(env);
+         LOONGARCH64LoadOp op;
+         switch(ty) {
+            case Ity_I8:
+               op = (am->tag == LAam_RI) ? LAload_LD_BU : LAload_LDX_BU;
+               break;
+            case Ity_I16:
+               op = (am->tag == LAam_RI) ? LAload_LD_HU : LAload_LDX_HU;
+               break;
+            case Ity_I32:
+               op = (am->tag == LAam_RI) ? LAload_LD_WU : LAload_LDX_WU;
+               break;
+            case Ity_I64:
+               op = (am->tag == LAam_RI) ? LAload_LD_D : LAload_LDX_D;
+               break;
+            default:
+               goto irreducible;
+         }
+         addInstr(env, LOONGARCH64Instr_Load(op, am, dst));
+         return dst;
+      }
 
       /* --------- BINARY OP --------- */
       case Iex_Binop: {
-- 
2.39.1

