From 804956661a49f3c7ebed04c44de420f025ed06da Mon Sep 17 00:00:00 2001
From: Feiyang Chen <chenfeiyang@loongson.cn>
Date: Mon, 21 Mar 2022 16:35:32 +0800
Subject: [PATCH v4 044/123] loongarch64: Implement
 genSpill_LOONGARCH64()/genReload_LOONGARCH64()/genMove_LOONGARCH64()

---
 VEX/priv/host_loongarch64_defs.c | 26 ++++++++++++++++++++++++++
 1 file changed, 26 insertions(+)

diff --git a/VEX/priv/host_loongarch64_defs.c b/VEX/priv/host_loongarch64_defs.c
index 0c3df7e95..1bc65f520 100644
--- a/VEX/priv/host_loongarch64_defs.c
+++ b/VEX/priv/host_loongarch64_defs.c
@@ -1706,7 +1706,17 @@ void genSpill_LOONGARCH64 ( /*OUT*/ HInstr** i1, /*OUT*/ HInstr** i2,
    vassert(offsetB >= 0);
    vassert(!hregIsVirtual(rreg));
 
+   LOONGARCH64AMode* am;
+   *i1 = *i2 = NULL;
+   am = LOONGARCH64AMode_RI(hregGSP(), offsetB);
+
    switch (hregClass(rreg)) {
+      case HRcInt64:
+         *i1 = LOONGARCH64Instr_Store(LAstore_ST_D, am, rreg);
+         break;
+      case HRcFlt64:
+         *i1 = LOONGARCH64Instr_FpStore(LAfpstore_FST_D, am, rreg);
+         break;
       default:
          ppHRegClass(hregClass(rreg));
          vpanic("genSpill_LOONGARCH64: unimplemented regclass");
@@ -1723,7 +1733,17 @@ void genReload_LOONGARCH64 ( /*OUT*/ HInstr** i1, /*OUT*/ HInstr** i2,
    vassert(offsetB >= 0);
    vassert(!hregIsVirtual(rreg));
 
+   LOONGARCH64AMode* am;
+   *i1 = *i2 = NULL;
+   am = LOONGARCH64AMode_RI(hregGSP(), offsetB);
+
    switch (hregClass(rreg)) {
+      case HRcInt64:
+         *i1 = LOONGARCH64Instr_Load(LAload_LD_D, am, rreg);
+         break;
+      case HRcFlt64:
+         *i1 = LOONGARCH64Instr_FpLoad(LAfpload_FLD_D, am, rreg);
+         break;
       default:
          ppHRegClass(hregClass(rreg));
          vpanic("genReload_LOONGARCH64: unimplemented regclass");
@@ -1737,6 +1757,12 @@ LOONGARCH64Instr* genMove_LOONGARCH64 ( HReg from, HReg to, Bool mode64 )
 {
    vassert(mode64 == True);
    switch (hregClass(from)) {
+      case HRcInt64:
+         return LOONGARCH64Instr_Binary(LAbin_OR,
+                                        LOONGARCH64RI_R(hregZERO()),
+                                        from, to);
+      case HRcFlt64:
+         return LOONGARCH64Instr_FpMove(LAfpmove_FMOV_D, from, to);
       default:
          ppHRegClass(hregClass(from));
          vpanic("genMove_LOONGARCH64: unimplemented regclass");
-- 
2.39.1

