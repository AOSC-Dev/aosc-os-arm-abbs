From d73ffc707849d871f607e08b0b41a634d0b2e3b6 Mon Sep 17 00:00:00 2001
From: Feiyang Chen <chenfeiyang@loongson.cn>
Date: Wed, 23 Mar 2022 16:34:51 +0800
Subject: [PATCH v4 090/123] loongarch64: Add support for redir

---
 coregrind/m_redir.c      | 16 +++++++++++++++-
 include/pub_tool_redir.h |  2 ++
 2 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/coregrind/m_redir.c b/coregrind/m_redir.c
index 176e2673c..b1dd2b23b 100644
--- a/coregrind/m_redir.c
+++ b/coregrind/m_redir.c
@@ -1229,6 +1229,7 @@ Bool VG_(is_soname_ld_so) (const HChar *soname)
    if (VG_STREQ(soname, VG_U_LD_LINUX_AARCH64_SO_1)) return True;
    if (VG_STREQ(soname, VG_U_LD_LINUX_ARMHF_SO_3))   return True;
    if (VG_STREQ(soname, VG_U_LD_LINUX_MIPSN8_S0_1))  return True;
+   if (VG_STREQ(soname, VG_U_LD_LINUX_LOONGARCH_LP64D_SO_1)) return True;
 #  elif defined(VGO_freebsd)
    if (VG_STREQ(soname, VG_U_LD_ELF_SO_1))   return True;
    if (VG_STREQ(soname, VG_U_LD_ELF32_SO_1))   return True;
@@ -1669,7 +1670,20 @@ void VG_(redir_initialise) ( void )
    }
 
 #elif defined(VGP_loongarch64_linux)
-   /* TODO */
+   /* If we're using memcheck, use these intercepts right from
+      the start, otherwise ld.so makes a lot of noise. */
+   if (0==VG_(strcmp)("Memcheck", VG_(details).name)) {
+      add_hardwired_spec(
+         "ld-linux-loongarch-lp64d.so.1", "strlen",
+         (Addr)&VG_(loongarch64_linux_REDIR_FOR_strlen),
+         complain_about_stripped_glibc_ldso
+      );
+      add_hardwired_spec(
+         "ld-linux-loongarch-lp64d.so.1", "index",
+         (Addr)&VG_(loongarch64_linux_REDIR_FOR_index),
+         complain_about_stripped_glibc_ldso
+      );
+   }
 
 #  elif defined(VGP_x86_solaris)
    /* If we're using memcheck, use these intercepts right from
diff --git a/include/pub_tool_redir.h b/include/pub_tool_redir.h
index f88d3b571..d1bb8cbce 100644
--- a/include/pub_tool_redir.h
+++ b/include/pub_tool_redir.h
@@ -321,6 +321,8 @@
 
 #define  VG_U_LD_LINUX_MIPSN8_S0_1  "ld-linux-mipsn8.so.1"
 
+#define  VG_U_LD_LINUX_LOONGARCH_LP64D_SO_1 "ld-linux-loongarch-lp64d.so.1"
+
 #endif
 
 /* --- Sonames for FreeBSD ELF linkers, plus unencoded versions. --- */
-- 
2.39.1

