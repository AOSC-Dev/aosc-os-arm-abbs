From 98ca0fc29e98ef9200a1c14af1e99b6281ec0737 Mon Sep 17 00:00:00 2001
From: Feiyang Chen <chenfeiyang@loongson.cn>
Date: Fri, 15 Jul 2022 15:36:39 +0800
Subject: [PATCH v4 112/123] loongarch64: Add none test for cpucfg instruction

---
 .gitignore                               |  3 +-
 none/tests/loongarch64/Makefile.am       |  2 +
 none/tests/loongarch64/cpucfg.c          | 24 ++++++++
 none/tests/loongarch64/cpucfg.stderr.exp |  0
 none/tests/loongarch64/cpucfg.stdout.exp | 72 ++++++++++++++++++++++++
 none/tests/loongarch64/cpucfg.vgtest     |  3 +
 6 files changed, 103 insertions(+), 1 deletion(-)
 create mode 100644 none/tests/loongarch64/cpucfg.c
 create mode 100644 none/tests/loongarch64/cpucfg.stderr.exp
 create mode 100644 none/tests/loongarch64/cpucfg.stdout.exp
 create mode 100644 none/tests/loongarch64/cpucfg.vgtest

diff --git a/.gitignore b/.gitignore
index d1db0e229..e0db9fc29 100644
--- a/.gitignore
+++ b/.gitignore
@@ -2053,13 +2053,14 @@
 /none/tests/loongarch64/allexec
 /none/tests/loongarch64/atomic
 /none/tests/loongarch64/branch
+/none/tests/loongarch64/cpucfg
 /none/tests/loongarch64/fault
 /none/tests/loongarch64/fault_fp
 /none/tests/loongarch64/float
 /none/tests/loongarch64/integer
 /none/tests/loongarch64/llsc
 /none/tests/loongarch64/memory
-none/tests/loongarch64/move
+/none/tests/loongarch64/move
 
 # /none/tests/scripts/
 /none/tests/scripts/*.dSYM
diff --git a/none/tests/loongarch64/Makefile.am b/none/tests/loongarch64/Makefile.am
index ec5ab1ad8..5015b420d 100644
--- a/none/tests/loongarch64/Makefile.am
+++ b/none/tests/loongarch64/Makefile.am
@@ -6,6 +6,7 @@ dist_noinst_SCRIPTS = filter_stderr
 EXTRA_DIST = \
 	atomic.stdout.exp atomic.stderr.exp atomic.vgtest \
 	branch.stdout.exp branch.stderr.exp branch.vgtest \
+	cpucfg.stdout.exp cpucfg.stderr.exp cpucfg.vgtest \
 	fault.stdout.exp fault.stderr.exp fault.vgtest \
 	fault_fp.stdout.exp fault_fp.stderr.exp fault_fp.vgtest \
 	float.stdout.exp float.stderr.exp float.vgtest \
@@ -18,6 +19,7 @@ check_PROGRAMS = \
 	allexec \
 	atomic \
 	branch \
+	cpucfg \
 	fault \
 	fault_fp \
 	float \
diff --git a/none/tests/loongarch64/cpucfg.c b/none/tests/loongarch64/cpucfg.c
new file mode 100644
index 000000000..f5d0570eb
--- /dev/null
+++ b/none/tests/loongarch64/cpucfg.c
@@ -0,0 +1,24 @@
+#include <stdio.h>
+
+void test(int reg)
+{
+    int res;
+    __asm__ __volatile__(
+        "cpucfg %0, %1 \n\t"
+        : "=r" (res)
+        : "r" (reg)
+        : "memory");
+    printf("cpucfg ::\n");
+    printf("input: %x\n", (unsigned)reg);
+    printf("output: %x\n", (unsigned)res);
+}
+
+int main(void)
+{
+    int i;
+
+    for (i = 0; i < 24; i++)
+        test(i);
+
+    return 0;
+}
diff --git a/none/tests/loongarch64/cpucfg.stderr.exp b/none/tests/loongarch64/cpucfg.stderr.exp
new file mode 100644
index 000000000..e69de29bb
diff --git a/none/tests/loongarch64/cpucfg.stdout.exp b/none/tests/loongarch64/cpucfg.stdout.exp
new file mode 100644
index 000000000..49e0ba7b1
--- /dev/null
+++ b/none/tests/loongarch64/cpucfg.stdout.exp
@@ -0,0 +1,72 @@
+cpucfg ::
+input: 0
+output: 14c010
+cpucfg ::
+input: 1
+output: 3f2f2fe
+cpucfg ::
+input: 2
+output: 7ccfc7
+cpucfg ::
+input: 3
+output: fcff
+cpucfg ::
+input: 4
+output: 5f5e100
+cpucfg ::
+input: 5
+output: 10001
+cpucfg ::
+input: 6
+output: 7f33
+cpucfg ::
+input: 7
+output: 0
+cpucfg ::
+input: 8
+output: 0
+cpucfg ::
+input: 9
+output: 0
+cpucfg ::
+input: a
+output: 0
+cpucfg ::
+input: b
+output: 0
+cpucfg ::
+input: c
+output: 0
+cpucfg ::
+input: d
+output: 0
+cpucfg ::
+input: e
+output: 0
+cpucfg ::
+input: f
+output: 0
+cpucfg ::
+input: 10
+output: 2c3d
+cpucfg ::
+input: 11
+output: 6080003
+cpucfg ::
+input: 12
+output: 6080003
+cpucfg ::
+input: 13
+output: 608000f
+cpucfg ::
+input: 14
+output: 60e000f
+cpucfg ::
+input: 15
+output: 0
+cpucfg ::
+input: 16
+output: 0
+cpucfg ::
+input: 17
+output: 0
diff --git a/none/tests/loongarch64/cpucfg.vgtest b/none/tests/loongarch64/cpucfg.vgtest
new file mode 100644
index 000000000..fea964445
--- /dev/null
+++ b/none/tests/loongarch64/cpucfg.vgtest
@@ -0,0 +1,3 @@
+prereq: ../../../tests/loongarch64_features cpucfg
+prog: cpucfg
+vgopts: -q
-- 
2.39.1

