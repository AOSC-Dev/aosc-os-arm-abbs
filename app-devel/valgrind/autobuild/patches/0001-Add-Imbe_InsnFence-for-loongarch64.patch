From 5d56476457784c3c09c013f240b5eb69cb2f764b Mon Sep 17 00:00:00 2001
From: Feiyang Chen <chenfeiyang@loongson.cn>
Date: Wed, 16 Mar 2022 10:48:54 +0800
Subject: [PATCH v4 001/123] Add Imbe_InsnFence for loongarch64

---
 VEX/priv/ir_defs.c   | 6 +++++-
 VEX/pub/libvex_ir.h  | 7 ++++++-
 drd/drd_load_store.c | 2 ++
 helgrind/hg_main.c   | 1 +
 4 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/VEX/priv/ir_defs.c b/VEX/priv/ir_defs.c
index 2d82c41a1..f8df05048 100644
--- a/VEX/priv/ir_defs.c
+++ b/VEX/priv/ir_defs.c
@@ -2094,6 +2094,8 @@ void ppIRMBusEvent ( IRMBusEvent event )
          vex_printf("Fence"); break;
       case Imbe_CancelReservation:
          vex_printf("CancelReservation"); break;
+      case Imbe_InsnFence:
+         vex_printf("InsnFence"); break;
       default:
          vpanic("ppIRMBusEvent");
    }
@@ -5246,7 +5248,9 @@ void tcStmt ( const IRSB* bb, const IRStmt* stmt, IRType gWordTy )
          break;
       case Ist_MBE:
          switch (stmt->Ist.MBE.event) {
-            case Imbe_Fence: case Imbe_CancelReservation:
+            case Imbe_Fence:
+            case Imbe_CancelReservation:
+            case Imbe_InsnFence:
                break;
             default: sanityCheckFail(bb,stmt,"IRStmt.MBE.event: unknown");
                break;
diff --git a/VEX/pub/libvex_ir.h b/VEX/pub/libvex_ir.h
index 85805bb69..034aca0ed 100644
--- a/VEX/pub/libvex_ir.h
+++ b/VEX/pub/libvex_ir.h
@@ -2662,7 +2662,12 @@ typedef
       /* Needed only on ARM.  It cancels a reservation made by a
          preceding Linked-Load, and needs to be handed through to the
          back end, just as LL and SC themselves are. */
-      Imbe_CancelReservation
+      Imbe_CancelReservation,
+      /* Needed only on LOONGARCH64.  It completes the synchronization
+         between the store operation and the instruction fetch operation
+         within a single processor core, and needs to be handed through
+         to the back end. */
+      Imbe_InsnFence
    }
    IRMBusEvent;
 
diff --git a/drd/drd_load_store.c b/drd/drd_load_store.c
index fba1dac71..435e5586d 100644
--- a/drd/drd_load_store.c
+++ b/drd/drd_load_store.c
@@ -634,6 +634,8 @@ IRSB* DRD_(instrument)(VgCallbackClosure* const closure,
             break; /* not interesting to DRD */
          case Imbe_CancelReservation:
             break; /* not interesting to DRD */
+         case Imbe_InsnFence:
+            break; /* not interesting to DRD */
          default:
             tl_assert(0);
          }
diff --git a/helgrind/hg_main.c b/helgrind/hg_main.c
index 26a37ead5..2af25a1c8 100644
--- a/helgrind/hg_main.c
+++ b/helgrind/hg_main.c
@@ -4851,6 +4851,7 @@ IRSB* hg_instrument ( VgCallbackClosure* closure,
             switch (st->Ist.MBE.event) {
                case Imbe_Fence:
                case Imbe_CancelReservation:
+               case Imbe_InsnFence:
                   break; /* not interesting */
                default:
                   goto unhandled;
-- 
2.39.1

