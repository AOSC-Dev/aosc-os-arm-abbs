From 603ea17492780866c176f28cbbd2c4ae3f88f7fe Mon Sep 17 00:00:00 2001
From: Feiyang Chen <chenfeiyang@loongson.cn>
Date: Tue, 19 Jul 2022 14:56:18 +0800
Subject: [PATCH v4 114/123] loongarch64: Add none test for special
 instructions

---
 .gitignore                                |   1 +
 none/tests/loongarch64/Makefile.am        |   6 +-
 none/tests/loongarch64/special.c          | 112 ++++++++++++++++++++++
 none/tests/loongarch64/special.stderr.exp |   0
 none/tests/loongarch64/special.stdout.exp |  48 ++++++++++
 none/tests/loongarch64/special.vgtest     |   2 +
 6 files changed, 167 insertions(+), 2 deletions(-)
 create mode 100644 none/tests/loongarch64/special.c
 create mode 100644 none/tests/loongarch64/special.stderr.exp
 create mode 100644 none/tests/loongarch64/special.stdout.exp
 create mode 100644 none/tests/loongarch64/special.vgtest

diff --git a/.gitignore b/.gitignore
index 1607a2341..738b4e33f 100644
--- a/.gitignore
+++ b/.gitignore
@@ -2062,6 +2062,7 @@
 /none/tests/loongarch64/memory
 /none/tests/loongarch64/move
 /none/tests/loongarch64/pc
+/none/tests/loongarch64/special
 
 # /none/tests/scripts/
 /none/tests/scripts/*.dSYM
diff --git a/none/tests/loongarch64/Makefile.am b/none/tests/loongarch64/Makefile.am
index d91fb12b6..c8e5b5123 100644
--- a/none/tests/loongarch64/Makefile.am
+++ b/none/tests/loongarch64/Makefile.am
@@ -14,7 +14,8 @@ EXTRA_DIST = \
 	llsc.stdout.exp llsc.stderr.exp llsc.vgtest \
 	memory.stdout.exp memory.stderr.exp memory.vgtest \
 	move.stdout.exp move.stderr.exp move.vgtest \
-	pc.stdout.exp pc.stderr.exp pc.vgtest
+	pc.stdout.exp pc.stderr.exp pc.vgtest \
+	special.stdout.exp special.stderr.exp special.vgtest
 
 check_PROGRAMS = \
 	allexec \
@@ -28,7 +29,8 @@ check_PROGRAMS = \
 	llsc \
 	memory \
 	move \
-	pc
+	pc \
+	special
 
 AM_CFLAGS    += @FLAG_M64@
 AM_CXXFLAGS  += @FLAG_M64@
diff --git a/none/tests/loongarch64/special.c b/none/tests/loongarch64/special.c
new file mode 100644
index 000000000..e1e8c9430
--- /dev/null
+++ b/none/tests/loongarch64/special.c
@@ -0,0 +1,112 @@
+#include <stdio.h>
+
+#define TESTINST_HRI(insn, hint, addr, offs)   \
+   {                                           \
+      __asm__ __volatile__(                    \
+         insn " " #hint ", %0, " #offs " \n\t" \
+         :                                     \
+         : "r" (addr)                          \
+         : "memory"                            \
+      );                                       \
+      printf("test %s\n", insn);               \
+   }
+
+#define TESTINST_HRR(insn, hint, addr, offs) \
+   {                                         \
+      __asm__ __volatile__(                  \
+         insn " %0, %1, \n\t"                \
+         :                                   \
+         : "r" (addr), "r" (offs)            \
+         : "memory"                          \
+      );                                     \
+      printf("test %s\n", insn);             \
+   }
+
+#define TESTINST_CODE(insn, code) \
+   {                              \
+      __asm__ __volatile__(       \
+         insn " " #code " \n\t"   \
+         :                        \
+         :                        \
+         : "memory"               \
+      );                          \
+      printf("test %s\n", insn);  \
+   }
+
+#define TESTINST_RR(insn, id)    \
+   {                             \
+      unsigned long res = 0;     \
+      __asm__ __volatile__(      \
+         insn " %0, %1 \n\t"     \
+         : "+r" (res)            \
+         : "r" (id)              \
+         : "memory"              \
+      );                         \
+      printf("test %s\n", insn); \
+      printf("res: %ld\n", res); \
+   }
+
+unsigned long mem[8];
+
+void test(void)
+{
+   /* ---------------- preld hint, rj, si12 ---------------- */
+   TESTINST_HRI("preld", 0, mem, 0);
+   TESTINST_HRI("preld", 1, mem, 1);
+   TESTINST_HRI("preld", 2, mem, 2);
+   TESTINST_HRI("preld", 3, mem, 3);
+   TESTINST_HRI("preld", 4, mem, 4);
+   TESTINST_HRI("preld", 5, mem, 5);
+   TESTINST_HRI("preld", 6, mem, 6);
+   TESTINST_HRI("preld", 7, mem, 7);
+   TESTINST_HRI("preld", 8, mem, 8);
+   TESTINST_HRI("preld", 9, mem, 9);
+
+   /* ---------------- preldx hint, rj, rk ---------------- */
+   TESTINST_HRI("preld", 31, mem, 10);
+   TESTINST_HRI("preld", 30, mem, 12);
+   TESTINST_HRI("preld", 29, mem, 14);
+   TESTINST_HRI("preld", 28, mem, 16);
+   TESTINST_HRI("preld", 27, mem, 18);
+   TESTINST_HRI("preld", 26, mem, 20);
+   TESTINST_HRI("preld", 25, mem, 22);
+   TESTINST_HRI("preld", 24, mem, 24);
+   TESTINST_HRI("preld", 23, mem, 26);
+   TESTINST_HRI("preld", 22, mem, 28);
+
+   /* ---------------- dbar code ---------------- */
+   TESTINST_CODE("dbar", 0);
+   TESTINST_CODE("dbar", 2);
+   TESTINST_CODE("dbar", 4);
+   TESTINST_CODE("dbar", 6);
+   TESTINST_CODE("dbar", 8);
+
+   /* ---------------- ibar code ---------------- */
+   TESTINST_CODE("ibar", 9);
+   TESTINST_CODE("ibar", 7);
+   TESTINST_CODE("ibar", 5);
+   TESTINST_CODE("ibar", 3);
+   TESTINST_CODE("ibar", 1);
+
+   /* ---------------- rdtimel.w rd, rj ---------------- */
+   TESTINST_RR("rdtimel.w", 0);
+   TESTINST_RR("rdtimel.w", 1);
+   TESTINST_RR("rdtimel.w", 2);
+
+   /* ---------------- rdtimeh.w rd, rj ---------------- */
+   TESTINST_RR("rdtimeh.w", 0);
+   TESTINST_RR("rdtimeh.w", 1);
+   TESTINST_RR("rdtimeh.w", 2);
+
+
+   /* ---------------- rdtime.d rd, rj ---------------- */
+   TESTINST_RR("rdtime.d", 0);
+   TESTINST_RR("rdtime.d", 1);
+   TESTINST_RR("rdtime.d", 2);
+}
+
+int main(void)
+{
+   test();
+   return 0;
+}
diff --git a/none/tests/loongarch64/special.stderr.exp b/none/tests/loongarch64/special.stderr.exp
new file mode 100644
index 000000000..e69de29bb
diff --git a/none/tests/loongarch64/special.stdout.exp b/none/tests/loongarch64/special.stdout.exp
new file mode 100644
index 000000000..7bd523e10
--- /dev/null
+++ b/none/tests/loongarch64/special.stdout.exp
@@ -0,0 +1,48 @@
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test preld
+test dbar
+test dbar
+test dbar
+test dbar
+test dbar
+test ibar
+test ibar
+test ibar
+test ibar
+test ibar
+test rdtimel.w
+res: 0
+test rdtimel.w
+res: 0
+test rdtimel.w
+res: 0
+test rdtimeh.w
+res: 0
+test rdtimeh.w
+res: 0
+test rdtimeh.w
+res: 0
+test rdtime.d
+res: 0
+test rdtime.d
+res: 0
+test rdtime.d
+res: 0
diff --git a/none/tests/loongarch64/special.vgtest b/none/tests/loongarch64/special.vgtest
new file mode 100644
index 000000000..b2f2ae952
--- /dev/null
+++ b/none/tests/loongarch64/special.vgtest
@@ -0,0 +1,2 @@
+prog: special
+vgopts: -q
-- 
2.39.1

