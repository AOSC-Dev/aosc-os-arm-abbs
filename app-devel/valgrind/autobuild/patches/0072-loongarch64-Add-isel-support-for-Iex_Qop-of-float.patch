From e01c486200883da7b1a459c17c5f65b1ed54a103 Mon Sep 17 00:00:00 2001
From: Feiyang Chen <chenfeiyang@loongson.cn>
Date: Mon, 8 Aug 2022 17:07:17 +0800
Subject: [PATCH v4 072/123] loongarch64: Add isel support for Iex_Qop of
 floating point expressions

---
 VEX/priv/host_loongarch64_isel.c | 40 ++++++++++++++++++++++++++++++++
 1 file changed, 40 insertions(+)

diff --git a/VEX/priv/host_loongarch64_isel.c b/VEX/priv/host_loongarch64_isel.c
index e4e4ff8fd..8f6e10f35 100644
--- a/VEX/priv/host_loongarch64_isel.c
+++ b/VEX/priv/host_loongarch64_isel.c
@@ -1761,6 +1761,46 @@ static HReg iselFltExpr_wrk ( ISelEnv* env, IRExpr* e )
       /* --------- QUATERNARY OP --------- */
       case Iex_Qop: {
          switch (e->Iex.Qop.details->op) {
+            case Iop_MAddF32: {
+               HReg  dst = newVRegF(env);
+               HReg src1 = iselFltExpr(env, e->Iex.Qop.details->arg2);
+               HReg src2 = iselFltExpr(env, e->Iex.Qop.details->arg3);
+               HReg src3 = iselFltExpr(env, e->Iex.Qop.details->arg4);
+               set_rounding_mode(env, e->Iex.Qop.details->arg1);
+               addInstr(env, LOONGARCH64Instr_FpTrinary(LAfpbin_FMADD_S, src3, src2, src1, dst));
+               set_rounding_mode_default(env);
+               return dst;
+            }
+            case Iop_MAddF64: {
+               HReg  dst = newVRegF(env);
+               HReg src1 = iselFltExpr(env, e->Iex.Qop.details->arg2);
+               HReg src2 = iselFltExpr(env, e->Iex.Qop.details->arg3);
+               HReg src3 = iselFltExpr(env, e->Iex.Qop.details->arg4);
+               set_rounding_mode(env, e->Iex.Qop.details->arg1);
+               addInstr(env, LOONGARCH64Instr_FpTrinary(LAfpbin_FMADD_D, src3, src2, src1, dst));
+               set_rounding_mode_default(env);
+               return dst;
+            }
+            case Iop_MSubF32: {
+               HReg  dst = newVRegF(env);
+               HReg src1 = iselFltExpr(env, e->Iex.Qop.details->arg2);
+               HReg src2 = iselFltExpr(env, e->Iex.Qop.details->arg3);
+               HReg src3 = iselFltExpr(env, e->Iex.Qop.details->arg4);
+               set_rounding_mode(env, e->Iex.Qop.details->arg1);
+               addInstr(env, LOONGARCH64Instr_FpTrinary(LAfpbin_FMSUB_S, src3, src2, src1, dst));
+               set_rounding_mode_default(env);
+               return dst;
+            }
+            case Iop_MSubF64: {
+               HReg  dst = newVRegF(env);
+               HReg src1 = iselFltExpr(env, e->Iex.Qop.details->arg2);
+               HReg src2 = iselFltExpr(env, e->Iex.Qop.details->arg3);
+               HReg src3 = iselFltExpr(env, e->Iex.Qop.details->arg4);
+               set_rounding_mode(env, e->Iex.Qop.details->arg1);
+               addInstr(env, LOONGARCH64Instr_FpTrinary(LAfpbin_FMSUB_D, src3, src2, src1, dst));
+               set_rounding_mode_default(env);
+               return dst;
+            }
             default:
                goto irreducible;
          }
-- 
2.39.1

