From b9473fd8bdfbbc623cca5eb29a879c87fcc5fbcb Mon Sep 17 00:00:00 2001
From: Feiyang Chen <chenfeiyang@loongson.cn>
Date: Thu, 31 Mar 2022 09:23:14 +0800
Subject: [PATCH v4 102/123] loongarch64: Implement tests for helgrind

---
 helgrind/tests/annotate_hbefore.c | 25 ++++++++++++++++++++++---
 helgrind/tests/tc07_hbl1.c        | 17 +++++++++++++----
 helgrind/tests/tc08_hbl2.c        | 17 +++++++++++++----
 3 files changed, 48 insertions(+), 11 deletions(-)

diff --git a/helgrind/tests/annotate_hbefore.c b/helgrind/tests/annotate_hbefore.c
index bc11c287c..3200c6cd0 100644
--- a/helgrind/tests/annotate_hbefore.c
+++ b/helgrind/tests/annotate_hbefore.c
@@ -320,9 +320,28 @@ UWord do_acasW ( UWord* addr, UWord expected, UWord nyu )
 /* return 1 if success, 0 if failure */
 UWord do_acasW ( UWord* addr, UWord expected, UWord nyu )
 {
-   /* TODO */
-   assert(0);
-   return 0;
+   UWord success;
+   UWord block[3] = { (UWord)addr, nyu, expected };
+
+   __asm__ __volatile__(
+      "   ld.d $t0, %1, 0   \n\t"
+      "   ld.d $t2, %1, 16  \n\t"
+      "   ld.d $t3, %1, 8   \n\t"
+      "   ll.d $t1, $t0, 0  \n\t"
+      "   bne  $t1, $t2, 1f \n\t"
+      "   sc.d $t3, $t0, 0  \n\t"
+      "   move %0, $t3      \n\t"
+      "   b    2f           \n\t"
+      "1:                   \n\t"
+      "   move %0, $zero    \n\t"
+      "2:                   \n\t"
+      : /*out*/ "=r" (success)
+      : /*in*/ "r" (&block[0])
+      : /*trash*/ "t0", "t1", "t2", "t3", "memory"
+   );
+
+   assert(success == 0 || success == 1);
+   return success;
 }
 
 #endif
diff --git a/helgrind/tests/tc07_hbl1.c b/helgrind/tests/tc07_hbl1.c
index 58f2fbc45..246d13c0b 100644
--- a/helgrind/tests/tc07_hbl1.c
+++ b/helgrind/tests/tc07_hbl1.c
@@ -135,10 +135,19 @@
       : /*trash*/ "$t0", "$t1", "memory"            \
    )
 #elif defined(PLAT_loongarch64_linux)
-   /* TODO */
-#include <assert.h>
-#  define INC(_lval,_lqual)                         \
-     assert(0);
+#  define INC(_lval,_lqual)                     \
+   __asm__ __volatile__ (                       \
+      "1:                     \n"               \
+      "   move   $t0, %0      \n"               \
+      "   ll.w   $t1, $t0, 0  \n"               \
+      "   addi.w $t1, $t1, 1  \n"               \
+      "   sc.w   $t1, $t0, 0  \n"               \
+      "   li.w   $t2, 1       \n"               \
+      "   bne    $t1, $t2, 1b \n"               \
+      : /*out*/                                 \
+      : /*in*/ "r" (&(_lval))                   \
+      : /*trash*/ "$t0", "$t1", "$t2", "memory" \
+   )
 #else
 #  error "Fix Me for this platform"
 #endif
diff --git a/helgrind/tests/tc08_hbl2.c b/helgrind/tests/tc08_hbl2.c
index 2758231a9..8683168a5 100644
--- a/helgrind/tests/tc08_hbl2.c
+++ b/helgrind/tests/tc08_hbl2.c
@@ -155,10 +155,19 @@
       : /*trash*/ "$t0", "$t1", "memory"            \
    )
 #elif defined(PLAT_loongarch64_linux)
-   /* TODO Implement. */
-#include <assert.h>
-#  define INC(_lval,_lqual)                         \
-     assert(0);
+#  define INC(_lval,_lqual)                     \
+   __asm__ __volatile__ (                       \
+      "1:                     \n"               \
+      "   move   $t0, %0      \n"               \
+      "   ll.w   $t1, $t0, 0  \n"               \
+      "   addi.w $t1, $t1, 1  \n"               \
+      "   sc.w   $t1, $t0, 0  \n"               \
+      "   li.w   $t2, 1       \n"               \
+      "   bne    $t1, $t2, 1b \n"               \
+      : /*out*/                                 \
+      : /*in*/ "r" (&(_lval))                   \
+      : /*trash*/ "$t0", "$t1", "$t2", "memory" \
+   )
 #else
 #  error "Fix Me for this platform"
 #endif
-- 
2.39.1

