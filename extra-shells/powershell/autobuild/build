export DOTNET_SKIP_FIRST_TIME_EXPERIENCE=1

abinfo "Download pre-built binaries"
wget -- "https://github.com/PowerShell/PowerShell/releases/download/v$PKGVER/powershell-$PKGVER-linux-x64.tar.gz"
mkdir .pwsh
tar -xf powershell-"$PKGVER"-linux-x64.tar.gz -C .pwsh
rm powershell-"$PKGVER"-linux-x64.tar.gz

abinfo "Build PowerShell"
.pwsh/pwsh -c "& {Import-Module \"./build.psm1\"; Start-PSBootstrap; Start-PSBuild -Output \"$PKGDIR/usr/lib/powershell\" -Runtime \"linux-x64\" -Configuration \"Release\"}"

abinfo "Apply temporary workaround"
mv "$PKGDIR"/usr/lib/Modules/* "$PKGDIR"/usr/lib/powershell/Modules
rm -r "$PKGDIR"/usr/lib/Modules/
mv "$PKGDIR"/usr/lib/ref "$PKGDIR"/usr/lib/powershell

abinfo "Deploy files"
chmod +x "$PKGDIR"/usr/lib/powershell/pwsh
mkdir -p "$PKGDIR"/usr/bin
ln -s /usr/lib/powershell/pwsh "$PKGDIR"/usr/bin/pwsh
