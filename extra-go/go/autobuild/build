export GOROOT="$SRCDIR"
export GOBIN="$GOROOT/bin"
export GOPATH="$SRCDIR/"
export GOROOT_FINAL=/usr/lib/go
export GOROOT_BOOTSTRAP=/usr/lib/go

export GOOS=linux
export GOARCH=arm

cd src

bash make.bash

for os in linux; do
    for arch in amd64 386; do
        export GOOS="$os"
        export GOARCH="$arch"
        bash make.bash --no-clean
    done
done

GOARCH=amd64

$GOROOT/bin/go get -d golang.org/x/tools/cmd/godoc
$GOROOT/bin/go build -o $SRCDIR/godoc golang.org/x/tools/cmd/godoc
for tool in vet cover callgraph; do
    $GOROOT/bin/go get -d golang.org/x/tools/cmd/${tool}
    $GOROOT/bin/go build -o $GOROOT/pkg/tool/${GOOS}_${GOARCH}/${tool} golang.org/x/tools/cmd/${tool}
done

cd ..

install -Dm755 "$SRCDIR/godoc" "$PKGDIR/usr/bin/godoc"

mkdir -p \
    "$PKGDIR/"{etc/profile.d,usr/{share/go,lib/go,lib/go/src,lib/go/site/src}}

cp -r doc misc -t "$PKGDIR/usr/share/go"
ln -s /usr/share/go/doc "$PKGDIR/usr/lib/go/doc"
cp -a bin "$PKGDIR/usr"
cp -a pkg "$PKGDIR/usr/lib/go"
cp -a "$GOROOT/src" "$PKGDIR/usr/lib/go/"
cp -a "$GOROOT/src/cmd" "$PKGDIR/usr/lib/go/src/cmd"
cp -a "$GOROOT/lib" "$PKGDIR/usr/lib/go/"

install -Dm644 src/Make.* "$PKGDIR/usr/lib/go/src"

find "$PKGDIR/usr/lib/go/src/" -type f -name '*.[ao]' -delete
find "$PKGDIR" -type f -name sql.go -exec chmod -x {} \;
find "$PKGDIR/usr/lib/go/src" -type f -executable -delete

ln -sf /usr/bin "$PKGDIR/usr/lib/go/bin"

install -Dm755 src/make.bash "$PKGDIR/usr/lib/go/src/make.bash"
install -Dm755 src/run.bash "$PKGDIR/usr/lib/go/src/run.bash"
cp -r misc/ "$PKGDIR/usr/lib/go/"

install -Dm644 favicon.ico "$PKGDIR/usr/lib/go/favicon.ico"
rm -f "$PKGDIR/usr/share/go/doc/articles/wiki/get.bin"

install -Dm644 VERSION "$PKGDIR/usr/lib/go/VERSION"
find "$PKGDIR/usr/"{lib/go/pkg,bin} -type f -exec touch '{}' +
