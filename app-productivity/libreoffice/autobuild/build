if ab_match_arch powerpc || \
   ab_match_arch ppc64 || \
   ab_match_arch loongson3; then
    export FIREBIRD="--disable-firebird-sdbc"
else
    export FIREBIRD="--enable-firebird-sdbc"
fi

noextract=(35c94d2df8893241173de1d16b6034c0-swingExSrc.zip
           798b2ffdc8bcfe7bca2cf92b62caf685-rhino1_5R5.zip
           a7983f859eafb2677d7ff386a023bc40-xsltml_2.1.2.zip
           0168229624cfac409e766913506961a8-ucpp-1.3.2.tar.gz
           language-subtag-registry-2021-03-05.tar.bz2
           17410483b5b5f267aa18b7e00b65e6e0-hsqldb_1_8_0.zip
           d8bd5eed178db6e2b18eeed243f85aa8-flute-1.1.6.zip
           ba2930200c9f019c2d93a8c88c651a0f-flow-engine-0.9.4.zip
           pdfium-6179.tar.bz2
           dtoa-20180411.tgz
           lxml-4.1.1.tgz
           Firebird-3.0.7.33374-0.tar.bz2
           skia-m116-2ddcf183eb260f63698aa74d1bb380f247ad7ccd.tar.xz
           dragonbox-1.1.3.tar.gz
           frozen-1.1.1.tar.gz
           zxcvbn-c-2.5.tar.gz
           Java-WebSocket-1.5.4.tar.gz
           8249374c274932a21846fa7629c2aa9b-officeotron-0.7.4-master.jar
           odfvalidator-1.2.0-incubating-SNAPSHOT-jar-with-dependencies-971c54fd38a968f5860014b44301872706f9e540.jar
           f543e6e2d7275557a839a164941c0a86e5f2c3f2a0042bfc434c88c6dde9e140-opens___.ttf
)


if ! bool $USECLANG; then
  # HACK: when not using clang, we also need to avoid LibO
  # force clang usage on Skia
  export LO_CLANG_CC=gcc
  export LO_CLANG_CXX=g++
fi

abinfo "Autogen-ing ..."
# FIXME: Use bundled GpgME as our version is too new for 7.3.
# Check again with 7.5.
./autogen.sh \
             --with-vendor="Anthon Open Source Community" \
             --with-parallelism="${ABTHREADS}" \
             --enable-split-app-modules \
             --enable-release-build \
             --with-external-tar="$SRCDIR"/ext_sources \
             --disable-fetch-external \
             --prefix=/usr --exec-prefix=/usr --sysconfdir=/etc \
             --libdir=/usr/lib --mandir=/usr/share/man \
             --with-lang="" \
             --with-jdk-home="/usr/lib/java" \
             --with-ant-home="/usr/share/apache-ant" \
             --with-sac-jar="/usr/share/java/sacjava/sac.jar" \
             --with-external-dict-dir=/usr/share/hunspell \
             --with-external-hyph-dir=/usr/share/hyphen \
             --with-external-thes-dir=/usr/share/mythes \
             --disable-avahi \
             --enable-dbus \
             --enable-evolution2 \
             --enable-gio \
             --enable-gtk3 \
             --enable-kf5 \
             --enable-introspection \
             --enable-openssl \
             --disable-odk \
             --enable-python=system \
             --enable-scripting-beanshell \
             --enable-scripting-javascript \
             --disable-dconf \
             --disable-report-builder \
             --enable-ext-wiki-publisher \
             --enable-ext-nlpsolver \
             --without-fonts \
             --with-system-libcdr \
             --with-system-mdds\
             --with-system-libvisio \
             --without-system-libcmis \
             --with-system-libmspub \
             --with-system-libexttextcat \
             --with-system-orcus \
             --with-system-liblangtag \
             --with-system-libodfgen \
             --with-system-libmwaw \
             --with-system-libetonyek \
             --with-system-libfreehand \
             --with-system-libtommath \
             --with-system-libatomic-ops \
             --with-system-libebook \
             --with-system-libabw \
             --with-system-coinmp \
             --with-system-dicts \
             --with-system-beanshell \
             --with-system-cppunit \
             --with-system-graphite\
             --with-system-glm \
             --with-system-libwpg \
             --with-system-libwps \
             --with-system-redland\
             --with-system-libzmf \
             --with-system-libstaroffice \
             --with-system-icu \
             --with-system-cairo \
             --with-system-libs \
             --with-system-mythes \
             --with-system-headers \
             --with-system-clucene \
             --without-system-boost \
             --without-system-firebird ${FIREBIRD} \
             --without-system-hsqldb \
             --without-system-mariadb \
             --without-system-gpgmepp \
             --without-myspell-dicts \
             --without-system-poppler \
             --without-junit \
             --without-system-box2d \
             --without-system-dragonbox \
             --without-system-libfixmath \
             --without-system-frozen \
             --with-gdrive-client-id="1006183841565.apps.googleusercontent.com" \
             --with-gdrive-client-secret="XN6oYWBv7O7w_heXB8TVuldr" \
             --disable-dependency-tracking \
             --enable-pch=full

if ab_match_arch loongarch64 || \
   ab_match_arch riscv64; then
    abinfo "Fetching Firebird ..."
    make UnpackedTarball_firebird

    abinfo "Applying patches for Firebird ..."
    ab_apply_patches "$SRCDIR"/autobuild/patches/*.firebird-deferred."${CROSS:-$ARCH}"
fi

abinfo "Fetching libgpg-error ..."
make UnpackedTarball_libgpg-error

for i in $(find "$SRCDIR" -name config.guess -o -name config.sub); do \
    abinfo "Copying replacement $i ..."
    cp -v /usr/bin/$(basename $i) $i ; \
done

abinfo "Building LibreOffice"
make

abinfo "Deploying files"
make distro-pack-install DESTDIR="$PKGDIR"

abinfo "Commencing installation of help data ..."
mkdir -pv "$SRCDIR"/build-help
cd "$SRCDIR"/build-help

for i in "$SRCDIR"/../*helppack*.tar.gz; do
    abinfo "Extracting help package $i ..."
    tar xvf $i
done

for i in "$SRCDIR"/build-help/LibreOffice*; do
    abinfo "Moving help RPM package $i ..."
    mv -v $i/RPMS/*.rpm "$SRCDIR"/build-help/
done

for i in "$SRCDIR"/build-help/*.rpm; do
    abinfo "Extracting help RPM package $i ..."
    rpmextract $i
done

abinfo "Installing help data ..."
mkdir -pv "$PKGDIR"/usr/lib/libreoffice
cp -R "$SRCDIR"/build-help/opt/libreoffice*/help \
     "$PKGDIR"/usr/lib/libreoffice/

abinfo "Commening building of i18n data ..."
mkdir -pv "$SRCDIR"/build-i18n
cd "$SRCDIR"/build-i18n

for i in "$SRCDIR"/../*langpack*.tar.gz; do
    abinfo "Extracing language pack $i ..."
    tar xvf $i
done

for i in "$SRCDIR"/build-i18n/LibreOffice*; do
    abinfo "Moving language pack RPM $i ..."
    mv -v $i/RPMS/*.rpm "$SRCDIR"/build-i18n/
done

for i in "$SRCDIR"/build-i18n/*.rpm; do
    abinfo "Extracting language pack RPM $i ..."
    rpmextract $i
done

abinfo "Installing language packs ..."
mkdir -pv "$PKGDIR"/usr/lib/libreoffice
cp -R "$SRCDIR"/build-i18n/opt/libreoffice*/* \
    "$PKGDIR"/usr/lib/libreoffice/
