cd "${SRCDIR}"
npm install --cache ${_NPM_CACHE}

cd "${SRCDIR}/packages/app-cli"
npm run build
cd "${SRCDIR}/packages/app-cli/build"
npm pack
npm install --production --global --user root --prefix "${PKGDIR}/usr" "$PKGNAME-$PKGVER.tgz"
cd "${PKGDIR}/usr"
mv "${PKGDIR}/usr/lib/node_modules/joplin" "${PKGDIR}/usr/lib/joplin"
rm -rv "${PKGDIR}/usr/lib/node_modules"
find "${PKGDIR}/usr" -type d -exec chmod 755 {} +
find "${PKGDIR}" -name package.json -print0 | xargs -0 sed -i "/_where/d"
jq '.|=with_entries(select(.key|test("_.+")|not))' "${PKGDIR}/usr/lib/joplin/package.json" > "${PKGDIR}/usr/lib/joplin/package.json"
chmod 644 "${PKGDIR}/usr/lib/joplin/package.json"

cd "${SRCDIR}/packages/app-desktop"
mkdir -p "${SRCDIR}/packages/app-desktop/dist/"
touch "${SRCDIR}/packages/app-desktop/dist/AppImage"
USE_HARD_LINKS=false npm run dist -- --publish=never --linux --x64 --dir="${SRCDIR}/packages/app-desktop/dist/"
mv "${SRCDIR}/packages/app-desktop/dist/linux-unpacked/@joplinapp-desktop" "${SRCDIR}/packages/app-desktop/dist/linux-unpacked/joplin-desktop"
cp -a "${SRCDIR}/packages/app-desktop/dist/linux-unpacked" "${PKGDIR}/usr/lib/joplin-desktop"
