# Adapted from Arch Linux
abinfo 'Preparing build environment ...'
install -dv "$SRCDIR"/src/github.com/syncthing
BASEDIR="$SRCDIR"/src/github.com/syncthing/syncthing
mv -v "$SRCDIR"/syncthing "$BASEDIR"

abinfo 'Exporting necessary Go building variables ...'
export BUILD_HOST=aosc
export BUILD_USER=syncthing
export EXTRA_LDFLAGS="-linkmode external -extldflags ${LDFLAGS}"
export GOPATH="$SRCDIR"
export GOROOT_FINAL="$BINDIR"

export CGO_CFLAGS="${CFLAGS}"
export CGO_CXXFLAGS="${CXXFLAGS}"
export GOFLAGS="-buildmode=pie -trimpath -mod=readonly -modcacherw"

abinfo 'Building binaries ...'
pushd "$BASEDIR"
go run build.go -no-upgrade -version v$PKGVER build
go run build.go -no-upgrade -version v$PKGVER build strelaysrv
popd

abinfo 'Installing binaries ...'
install -Dvm755 "$BASEDIR"/syncthing "$PKGDIR"/usr/bin/syncthing
install -Dvm755 "$BASEDIR"/strelaysrv "$PKGDIR"/usr/bin/syncthing-relaysrv

abinfo 'Installing systemd service unit files ...'
install -Dvm644 "$BASEDIR"/etc/linux-systemd/system/syncthing-resume.service \
    "$PKGDIR"/usr/lib/systemd/system/syncthing-resume.service
install -Dvm644 "$BASEDIR"/etc/linux-systemd/system/syncthing@.service \
    "$PKGDIR"/usr/lib/systemd/system/syncthing@.service
install -Dvm644 "$BASEDIR"/etc/linux-systemd/user/syncthing.service \
    "$PKGDIR"/usr/lib/systemd/user/syncthing.service

abinfo 'Installing man pages ...'
for file in $(find "$BASEDIR"/man -name '*.1' -print); do
    install -Dvm644 $file "$PKGDIR"/usr/share/man/man1/$file
done
for file in $(find "$BASEDIR"/man -name '*.5' -print); do
    install -Dvm644 $file "$PKGDIR"/usr/share/man/man5/$file
done
for file in $(find "$BASEDIR"/man -name '*.7' -print); do
    install -Dvm644 $file "$PKGDIR"/usr/share/man/man7/$file
done
