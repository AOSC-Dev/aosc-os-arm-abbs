#
# Adapted from AUR package: telegram-desktop
#

cd Libraries/QtStatic
./configure -prefix "$SRCDIR/qt" \
            -release \
            -opensource \
            -confirm-license \
            -qt-xcb \
            -no-opengl \
            -static \
            -nomake examples \
            -nomake tests \
            -skip qtquick1 \
            -skip qtdeclarative

make module-qtbase module-qtimageformats
make module-qtbase-install_subtargets module-qtimageformats-install_subtargets
	
export PATH="$srcdir/qt/bin:$PATH"

cd $SRCDIR
	
mkdir -p tdesktop/Linux/{Debug,Release}Intermediate{Style,Emoji,Lang,Updater,}
	
for build_type in debug release; do
	for x in Style Lang; do
		cd $SRCDIR/tdesktop/Linux/${build_type^}Intermediate$x
		qmake CONFIG+="${build_type}" ../../Telegram/Meta$x.pro
		make
	done
	
	cd $SRCDIR/tdesktop/Linux/${build_type^}Intermediate

	if ! [ -d "$SRCDIR/tdesktop/Telegram/GeneratedFiles" ]; then
		qmake CONFIG+="${build_type}" ../../Telegram/Telegram.pro
		awk '$1 == "PRE_TARGETDEPS" { $1=$2="" ; print }' $SRCDIR/tdesktop/Telegram/Telegram.pro | xargs xvfb-run -a make
	fi
	
	qmake CONFIG+="${build_type}" ../../Telegram/Telegram.pro
	xvfb-run -a make
done

install -dm755 $PKGDIR/usr/bin
install -m755 $SRCDIR/tdesktop/Linux/Release/Telegram $PKGDIR/usr/bin/telegram-desktop

for icon_size in 16 32 48 64 128 256 512; do
	icon_dir="$PKGDIR/usr/share/icons/hicolor/${icon_size}x${icon_size}/apps"
	install -d $icon_dir
	install -m644 $SRCDIR/tdesktop/Telegram/SourceFiles/art/icon${icon_size}.png $icon_dir/telegram-desktop.png
done
