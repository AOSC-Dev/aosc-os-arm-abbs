./configure --host=$HOST --prefix=/usr --mandir=/usr/share/man --libexecdir=/usr/lib \
	    --sysconfdir=/etc --localstatedir=/var/lib/openldap --sbindir=/usr/bin \
    	    --enable-ipv6 --enable-syslog --enable-local \
    	    --disable-bdb --disable-hdb \
    	    --enable-crypt --enable-dynamic \
    	    --with-threads --disable-wrappers \
    	    --without-fetch \
    	    --enable-spasswd --with-cyrus-sasl \
    	    --enable-overlays=mod --enable-modules=yes
make $ABMK
cd contrib/slapd-modules/nssov/
make prefix=/usr libexecdir=/usr/lib sysconfdir=/etc/openldap $ABMK
chrpath -d .libs/nssov.so
cd ../../../
make install DESTDIR=`pwd`/abdist
for dir in include libraries doc/man/man3 ; do
	pushd ${dir}
	make DESTDIR=`pwd`/abdist install
	popd
done
rm `pwd`/abdist/etc/openldap/*.default
ln -sf liblber.so `pwd`/abdist/usr/lib/liblber.so.2
ln -sf libldap.so `pwd`/abdist/usr/lib/libldap.so.2
install -Dm644 doc/man/man5/ldap.conf.5.tmp `pwd`/abdist/usr/share/man/man5/ldap.conf.5
for dir in clients servers doc/man/man{1,5,8}; do
	pushd ${dir}
	make DESTDIR=`pwd`/abdist install
	popd
done
pushd contrib/slapd-modules/nssov
install -m755 .libs/nssov.so.0.0.0 `pwd`/../../../abdist/usr/lib/openldap
ln -s nssov.so.0.0.0 `pwd`/../../../abdist/usr/lib/openldap/nssov.so
ln -s nssov.so.0.0.0 `pwd`/../../../abdist/usr/lib/openldap/nssov.so.0
install -m444 ldapns.schema `pwd`/../../../abdist/etc/openldap/schema
popd
rm `pwd`/abdist/usr/share/man/man5/ldap.conf.5
rm -r `pwd`/abdist/run
rm `pwd`/abdist/etc/openldap/*.default
ln -s ../lib/slapd `pwd`/abdist/usr/bin/slapd
chown root:439 `pwd`/abdist/etc/openldap/{slapd.{conf,ldif},DB_CONFIG.example}
chmod 640 `pwd`/abdist/etc/openldap/{slapd.{conf,ldif},DB_CONFIG.example}
install -dm700 -o 439 -g 439 `pwd`/abdist/var/lib/openldap
install -dm700 -o 439 -g 439 `pwd`/abdist/etc/openldap/slapd.d
