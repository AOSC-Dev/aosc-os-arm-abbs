From d43b8bbbdf3ce7b2dc1a7138e2c8c76f88d7953c Mon Sep 17 00:00:00 2001
From: Mingcong Bai <jeffbai@aosc.io>
Date: Tue, 21 Jan 2025 12:28:46 +0800
Subject: [PATCH] FLIGHT: usbcore: attempt to enable remote wakeup for each
 device

Signed-off-by: Mingcong Bai <jeffbai@aosc.io>
---
 drivers/usb/core/hub.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/drivers/usb/core/hub.c b/drivers/usb/core/hub.c
index 21ac9b464696..f670d1481ef9 100644
--- a/drivers/usb/core/hub.c
+++ b/drivers/usb/core/hub.c
@@ -3471,6 +3471,9 @@ int usb_port_suspend(struct usb_device *udev, pm_message_t msg)
 	 * we don't explicitly enable it here.
 	 */
 	if (udev->do_remote_wakeup) {
+		struct usb_hub *i_hub;
+		struct usb_device *i_udev;
+
 		status = usb_enable_remote_wakeup(udev);
 		if (status) {
 			dev_dbg(&udev->dev, "won't remote wakeup, status %d\n",
@@ -3479,6 +3482,14 @@ int usb_port_suspend(struct usb_device *udev, pm_message_t msg)
 			if (PMSG_IS_AUTO(msg))
 				goto err_wakeup;
 		}
+
+		i_udev = hub->hdev;
+
+		while (i_udev) {
+			usb_enable_remote_wakeup(i_udev);
+			i_hub = usb_hub_to_struct_hub(i_udev->parent);
+			i_udev = i_hub ? i_hub->hdev : NULL;
+		}
 	}
 
 	/* disable USB2 hardware LPM */
-- 
2.48.1

