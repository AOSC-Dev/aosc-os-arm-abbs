From 7f1edb18ae5e8fdd62cae26f81291d5775597a52 Mon Sep 17 00:00:00 2001
From: Mingcong Bai <jeffbai@aosc.io>
Date: Fri, 14 Feb 2025 23:19:46 +0800
Subject: [PATCH 319/319] FLIGHT: tg3: disable HIGHDMA for BCM5762

Signed-off-by: Mingcong Bai <jeffbai@aosc.io>

Link: https://t.me/c/1109254909/758362
Signed-off-by: Kexy Biscuit <kexybiscuit@aosc.io>
---
 drivers/net/ethernet/broadcom/tg3.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/drivers/net/ethernet/broadcom/tg3.c b/drivers/net/ethernet/broadcom/tg3.c
index c15197c68062..279012376d07 100644
--- a/drivers/net/ethernet/broadcom/tg3.c
+++ b/drivers/net/ethernet/broadcom/tg3.c
@@ -17871,6 +17871,14 @@ static int tg3_init_one(struct pci_dev *pdev,
 
 	tg3_init_bufmgr_config(tp);
 
+	/*
+	 * 5762 chips may not work reliably with high DMA enabled.
+	 */
+	if (tp->pdev->device == TG3PCI_DEVICE_TIGON3_5762) {
+		dev_err(&pdev->dev, "disable HIGHDMA for Tigon3 device 5762\n");
+		features &= ~NETIF_F_HIGHDMA;
+	}
+
 	/* 5700 B0 chips do not support checksumming correctly due
 	 * to hardware bugs.
 	 */
-- 
2.48.1

