From 71f7e2e4aacca24e86f8b0c0c83100d5147de962 Mon Sep 17 00:00:00 2001
From: Huacai Chen <chenhc@lemote.com>
Date: Thu, 1 Dec 2016 09:51:35 +0800
Subject: [PATCH 176/273] AOSCOS: GPIO: Reset usb One-Way-Import chip for TMCS

Signed-off-by: Huacai Chen <chenhc@lemote.com>

Signed-off-by: Kexy Biscuit <kexybiscuit@aosc.io>
---
 .../include/asm/mach-loongson64/workarounds.h |  1 +
 arch/mips/loongson64/workarounds.c            | 28 +++++++++++++++++++
 2 files changed, 29 insertions(+)

diff --git a/arch/mips/include/asm/mach-loongson64/workarounds.h b/arch/mips/include/asm/mach-loongson64/workarounds.h
index f669ab6df0eb..e747f9c495bc 100644
--- a/arch/mips/include/asm/mach-loongson64/workarounds.h
+++ b/arch/mips/include/asm/mach-loongson64/workarounds.h
@@ -6,6 +6,7 @@
 #define WORKAROUND_CPUHOTPLUG	0x00000002
 #define WORKAROUND_LVDS_EC 	0x00000004
 #define WORKAROUND_LVDS_GPIO	0x00000008
+#define WORKAROUND_USB_TMCS	0x00000010
 
 void gpio_lvds_off(void);
 void turn_off_lvds(void);
diff --git a/arch/mips/loongson64/workarounds.c b/arch/mips/loongson64/workarounds.c
index 61709f6eef66..e1be51474329 100644
--- a/arch/mips/loongson64/workarounds.c
+++ b/arch/mips/loongson64/workarounds.c
@@ -36,3 +36,31 @@ void turn_on_lvds(void)
 	if (loongson_sysconf.workarounds & WORKAROUND_LVDS_GPIO)
 		gpio_lvds_on();
 }
+
+static int __init usb_fix_for_tmcs(void)
+{
+	if (loongson_sysconf.workarounds & WORKAROUND_USB_TMCS) {
+		gpio_request(13, "gpio13");
+		gpio_request(12, "gpio12");
+		gpio_request(11, "gpio11");
+		gpio_request(9, "gpio9");
+		gpio_request(8, "gpio8");
+
+		gpio_direction_output(11, 1);
+		msleep(1000);
+		gpio_direction_output(13, 0);
+		gpio_direction_output(12, 0);
+		gpio_direction_output(9, 0);
+		gpio_direction_output(8, 0);
+
+		gpio_set_value(8, 1);
+		gpio_set_value(13, 1);
+		msleep(1000);
+		gpio_set_value(9, 1);
+		gpio_set_value(12, 1);
+	}
+
+	return 0;
+}
+
+late_initcall(usb_fix_for_tmcs);
-- 
2.47.1

