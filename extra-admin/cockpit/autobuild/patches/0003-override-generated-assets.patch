--- a/dist/static/login.js	2022-12-20 08:13:27.000000000 -0700
+++ b/dist/static/login.js	2022-12-27 01:00:07.113874289 -0700
@@ -1 +1 @@
-(()=>{"use strict";!function(t){let e;try{e=window.localStorage,window.localStorage.removeItem("url-root"),window.localStorage.removeItem("standard-login")}catch(n){e=window.sessionStorage,t.warn(String(n))}const n=e.getItem("shell:style");let o;window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&"auto"===n||"dark"===n?document.documentElement.classList.add("pf-theme-dark"):document.documentElement.classList.remove("pf-theme-dark"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(t=>{t.matches&&"auto"===n||"dark"===n?document.documentElement.classList.add("pf-theme-dark"):document.documentElement.classList.remove("pf-theme-dark")}));const i=window.environment||{},s=i.OAuth||null;s&&(s.TokenParam||(s.TokenParam="access_token"),s.ErrorParam||(s.ErrorParam="error_description"));const r=/\$\{([^}]+)\}|\$([a-zA-Z0-9_]+)/g;function a(t){const e=Array.prototype.slice.call(arguments,1);return t.replace(r,(function(t,n,o){return e[n||o]||""}))}function c(t){if(window.cockpit_po){const e=window.cockpit_po[t];if(e&&e[1])return e[1]}return t}const l=c;let d,u,p,g;const f=/[?&]?([^=]+)=([^&]*)/g;let w=null;function m(t){t=t.split("+").join(" ");const e={};for(;;){const n=f.exec(t);if(!n)break;e[decodeURIComponent(n[1])]=decodeURIComponent(n[2])}return e}function h(t){return document.getElementById(t)}function v(t,e){"string"==typeof t&&(t=[t]);for(let n=0;n<t.length;n++)if("string"==typeof t[n]){const o=document.querySelectorAll(t[n]);o&&o.forEach((function(t){t.hidden!==!!e&&(t.hidden=!!e)}))}else t[n].hidden!==!!e&&(t[n].hidden=!!e)}function k(){v(arguments,!1)}function y(){v(arguments,!0)}function x(e){window.console&&t.warn("fatal:",e),y("#login-again","#login-wait-validating"),w&&(h("login-again").href=w,k("#login-again")),y("#login","#login-details"),k("#login-fatal");const n=h("login-fatal-message");n.textContent="",n.appendChild(document.createTextNode(e))}function b(t,e){const n=h(t),o=n&&window.getComputedStyle?window.getComputedStyle(n,":before"):null;if(!o)return;let i=o.content;if(i&&"none"!=i&&"normal"!=i){const t=i.length;('"'===i[0]||"'"===i[0])&&t>2&&i[t-1]===i[0]&&(i=i.substr(1,t-2)),n.innerHTML=i||e}else n.removeAttribute("class")}function C(){function e(e,n){"supports"===e&&(e="@supports API");const o=a(l("This web browser is too old to run the Web Console (missing $0)"),e);window.console&&t.warn(o),h("login-error-message").textContent=o,k("#unsupported-browser","#error-group"),document.body.classList.add("unsupported-browser"),function(t){t?(k("#login","#login-details","#login-override"),y("#get-out-link"),h("login-override-content").appendChild(h("login")),h("login-button").classList.add("pf-m-warning"),document.querySelector("#login .login-actions").insertAdjacentHTML("beforebegin","<div class='pf-c-helper-text pf-m-warning' id='bypass-warning'>"+l("Cockpit might not render correctly in your browser")+"</div>")):y("#login","#login-details","#login-override")}(n)}function n(t,n){let o;try{o=n&&n[t]}catch(e){throw x(a(l("The web browser configuration prevents Cockpit from running (inaccessible $0)"),t)),e}return void 0!==o||(e(t),!1)}function o(){const t=[].join.call(arguments,": ");return!(!window.CSS||!window.CSS.supports.apply(this,arguments))||(e(t,"bypass"),!1)}return!!(n("WebSocket",window)&&n("XMLHttpRequest",window)&&n("sessionStorage",window)&&n("JSON",window)&&n("defineProperty",Object)&&n("console",window)&&n("pushState",window.history)&&n("textContent",document)&&n("replaceAll",String.prototype)&&n("finally",Promise.prototype)&&n("supports",window.CSS))&&(o("display","flex")&&o("display","grid")&&o("selector(test)")&&o("selector(:is(*):where(*))"),!0)}function S(t){return t.replace(/^\s+|\s+$/g,"")}function L(t){const n=document.createElement("a"),s=document.baseURI;t=t||"/",n.href=s,"/"!=n.pathname&&(o=n.pathname.replace(/^\/+|\/+$/g,""),e.setItem("url-root",o),o&&0===t.indexOf("/"+o)&&(t=t.replace("/"+o,"")||"/")),0===t.indexOf("/=")?(i.hostname=t.substring(2).split("/")[0],h("server-field").value=i.hostname,I(null,!0),t="/cockpit+"+t.split("/")[1]):0!==t.indexOf("/cockpit/")&&0!==t.indexOf("/cockpit+")&&(t="/cockpit"),u=t.split("/")[1],d="/"+u+"/login",o&&(d="/"+o+d),g=u,p=d}function I(t,e){t&&"keypress"===t.type&&" "!==t.key||(t&&"click"===t.type&&t.preventDefault(),void 0===e&&(e=h("server-group").hidden),v("#server-group",!e),h("option-group").setAttribute("data-state",e))}function E(t){const e=h("login-password-input");e.setAttribute("type","password"===e.getAttribute("type")?"text":"password"),t.stopPropagation()}function T(){const t=window.location.href.split("#",2);w=s.URL,s.URL.indexOf("?")>-1?w+="&":w+="?",w+="redirect_uri="+encodeURIComponent(t[0])}function _(){y("#error-group"),h("login-error-message").textContent=""}function O(){y("#info-group"),h("login-info-message").textContent=""}function A(t,e){_(),t&&(s?x(t):($(e||"login"),h("login-error-message").textContent=t,k("#error-group")))}function R(t){h("server-field").value?(_(),h("login-error-message").textContent=t,k("#error-group"),I(null,!0),$("login")):A(t)}function U(){return i.page.require_host&&-1===g.indexOf("cockpit+=")}function H(){let n=[];try{n=JSON.parse(e.getItem("cockpit-client-sessions")||"[]")}catch(e){t.log("Failed to parse 'cockpit-client-sessions':",e)}return n}function N(){A(null);const t=S(h("login-user-input").value);if(""!==t||i.is_cockpit_client)if(U()&&""===h("server-field").value)A(l("Please specify the host to connect to"));else{const n=h("server-field").value;n?(u="cockpit+="+n,d=p.replace("/"+g+"/","/"+u+"/"),h("brand").style.display="none",h("badge").style.visibility="hidden"):(u=g,d=p,b("badge",""),b("brand","Cockpit")),h("server-name").textContent=n||i.hostname,h("login-button").removeEventListener("click",N);const o=h("login-password-input").value,s="superuser:"+t+(n?":"+n:""),r=e.getItem(s)||"none";e.setItem("superuser-key",s),e.setItem(s,r),e.setItem("standard-login",!0);const a={Authorization:"Basic "+window.btoa(W(t+":"+o)),"X-Superuser":r};n&&(a["X-SSH-Connect-Unknown-Hosts"]="yes"),G("GET",a,!1)}else A(l("User name cannot be empty"))}function P(){const t=H(),n=h("recent-hosts-list");n.innerHTML="",t.forEach((o=>{const i=document.createElement("div");i.classList.add("host-line");const s=document.createElement("button");s.textContent=o,s.classList.add("pf-c-button","pf-m-tertiary","host-name"),s.addEventListener("click",(()=>{h("server-field").value=o,N()}));const r=document.createElement("button");r.title=l("Remove host"),r.ariaLabel=r.title,r.classList.add("host-remove"),r.addEventListener("click",(()=>{const n=t.indexOf(o);t.splice(n,1),e.setItem("cockpit-client-sessions",JSON.stringify(t)),P()})),i.append(s,r),n.append(i)})),v("#recent-hosts",0==t.length)}function $(t){const e=i.page.connect;let n=h("option-group").getAttribute("data-state");if(y("#login-wait-validating"),k("#login"),v("#login-details",i.is_cockpit_client),v("#server-field-label",i.is_cockpit_client),i.is_cockpit_client){const t=h("brand");t.textContent=l("Connect to:"),t.classList.add("text-brand")}v(["#user-group","#password-group"],"login"!=t||i.is_cockpit_client),v("#conversation-group","conversation"!=t),v("#hostkey-group","hostkey"!=t),h("login-button-text").textContent=l("hostkey"==t?"Accept key and log in":"Log in"),"login"!=t&&(h("login-password-input").value=""),i.page.require_host?(y("#option-group"),n=!0):v("#option-group",!e||"login"!=t),e&&"login"==t?v("#server-group",!n):y("#server-group"),h("login-button").removeAttribute("disabled"),h("login-button").removeAttribute("spinning"),h("login-button").classList.remove("pf-m-danger"),h("login-button").classList.add("pf-m-primary"),y("#get-out-link"),"login"==t&&h("login-button").addEventListener("click",N),i.is_cockpit_client&&(P(),document.body.classList.add("cockpit-client"))}function q(t){var e;e=t,O(),e&&(h("login-info-message").textContent=e,k("#info-group")),h("server-name").textContent=document.title,function(t){const e=h("login-note");t?(k(e),e.textContent=t):e.innerHTML="&nbsp;"}(l("Log in with your server user account.")),h("login-user-input").addEventListener("keydown",(function(t){A(null),O(),13==t.which&&h("login-password-input").focus()}),!1),h("login-password-input").addEventListener("keydown",(function(t){A(null),13==t.which&&N()})),h("login-password-toggle").addEventListener("click",E),$("login"),i.is_cockpit_client?i.page.require_host&&h("server-field").focus():h("login-user-input").focus()}function J(n){const o=function(){try{return JSON.parse(e.getItem("known_hosts")||"{ }")}catch(e){return t.warn("Can't parse known_hosts database in localStorage",e),{}}}(),i=n["host-key"],s=i.split(" ")[0],r=i.split(" ")[1];o[s]!=i?(o[s]?(h("hostkey-title").textContent=a(l("$0 key changed"),h("server-field").value),k("#hostkey-warning-group"),h("hostkey-message-1").textContent=""):(h("hostkey-title").textContent=l("New host"),y("#hostkey-warning-group"),h("hostkey-message-1").textContent=a(l("You are connecting to $0 for the first time."),h("server-field").value)),h("hostkey-verify-help-1").textContent=a(l("To verify a fingerprint, run the following on $0 while physically sitting at the machine or through a trusted network:"),h("server-field").value),h("hostkey-verify-help-cmds").textContent=a("ssh-keyscan$0 localhost | ssh-keygen -lf -",r?" -t "+r:""),h("hostkey-fingerprint").textContent=n.default,r?(h("hostkey-type").textContent=a("($0)",r),k("#hostkey-type")):y("#hostkey-type"),A(""),h("login-button").addEventListener("click",(function r(){h("login-button").removeEventListener("click",r),A(null,"hostkey"),o[s]=i,function(n){try{e.setItem("known_hosts",JSON.stringify(n))}catch(e){t.warn("Can't write known_hosts database to localStorage",e)}}(o),j(n.id,n.default)})),$("hostkey"),k("#get-out-link"),o[s]&&(h("login-button").classList.add("pf-m-danger"),h("login-button").classList.remove("pf-m-primary"))):j(n.id,n.default)}function M(t){if(t["host-key"])return void J(t);const e=t.echo?"text":"password";h("conversation-prompt").textContent=t.prompt;const n=h("conversation-message"),o=t.error||t.message;o?(n.textContent=o,k(n)):y(n);const i=h("conversation-input");function s(){h("conversation-input").removeEventListener("keydown",r),h("login-button").removeEventListener("click",s),A(null,"conversation"),j(t.id,h("conversation-input").value)}function r(t){A(null,"conversation"),13==t.which&&s()}i.value="",t.default&&(i.value=t.default),i.setAttribute("type",e),A(""),h("conversation-input").addEventListener("keydown",r),h("login-button").addEventListener("click",s),$("conversation"),i.focus()}function W(t){return window.unescape(encodeURIComponent(t))}function X(e,n){if(!e)return null;const o=e.split(" ");if("x-conversation"!==o[0].toLowerCase()&&3!=o.length)return null;const i=o[1];let s,r;try{s=window.atob(o[2])}catch(e){return window.console&&t.error("Invalid prompt data",e),null}try{r=JSON.parse(n)}catch(e){window.console&&t.log("Got invalid JSON response for prompt data",e),r={}}return r.id=i,r.prompt=s,r}function G(e,n,o){h("login-button").setAttribute("disabled","true"),h("login-button").setAttribute("spinning","true");const i=new XMLHttpRequest;i.open(e,d,!0);for(const t in n)i.setRequestHeader(t,n[t]);i.onreadystatechange=function(){if(4==i.readyState)if(200==i.status)B(JSON.parse(i.responseText));else if(401==i.status){const e=i.getResponseHeader("WWW-Authenticate");if(e&&0===e.toLowerCase().indexOf("x-conversation")){const t=X(e,i.responseText);t?M(t):x(l("Internal error: Invalid challenge header"))}else if(window.console&&t.log(i.statusText),i.statusText.startsWith("captured-stderr:"))!function(e){window.console&&t.warn("stderr:",e),y("#login-wait-validating"),y("#login","#login-details"),k("#login-fatal"),h("login-again").onclick=()=>{y("#login-fatal"),q()},k("#login-again");const n=h("login-fatal-message");n.textContent="",n.appendChild(document.createTextNode(e))}(decodeURIComponent(i.statusText.replace(/^captured-stderr:/,"")));else if(i.statusText.indexOf("authentication-not-supported")>-1){const t=S(h("login-user-input").value);x(a(l("The server refused to authenticate '$0' using password authentication, and no other supported authentication methods are available."),t))}else i.statusText.indexOf("terminated")>-1?A(l("Authentication failed: Server closed connection")):i.statusText.indexOf("no-host")>-1?R(l("Unable to connect to that address")):i.statusText.indexOf("unknown-hostkey")>-1?R(l("Refusing to connect. Hostkey is unknown")):i.statusText.indexOf("unknown-host")>-1?R(l("Refusing to connect. Host is unknown")):i.statusText.indexOf("invalid-hostkey")>-1?R(l("Refusing to connect. Hostkey does not match")):A(l(o?"Authentication failed":"Wrong user name or password"))}else 403==i.status?A(l(decodeURIComponent(i.statusText))||l("Permission denied")):i.statusText?x(decodeURIComponent(i.statusText)):x(a(l("$0 error"),i.status))},i.send()}function j(t,e){G("GET",{Authorization:"X-Conversation "+t+" "+window.btoa(W(e))},!0)}function z(t,e,n){let o=0;for(;o<t.length;){const i=t.key(o);n&&0!==i.indexOf("cockpit")||0===i.indexOf(e)?t.removeItem(i):o++}}function B(t){let n=window.sessionStorage.getItem("login-wanted");const s=h("server-field").value;if(s&&i.is_cockpit_client){const t=H();t.indexOf(s)<0&&(t.push(s),e.setItem("cockpit-client-sessions",JSON.stringify(t)))}s&&u!=g&&(n="/="+s,o&&(n="/"+o+n)),z(window.sessionStorage,u,!1),function(t){if(z(window.sessionStorage,u,!0),e.removeItem("login-data"),z(e,u,!1),t&&t["login-data"]){const n=JSON.stringify(t["login-data"]);e.setItem(u+"login-data",n),e.setItem("login-data",n)}o&&e.setItem("url-root",o);const n=i.CACertUrl;n&&window.sessionStorage.setItem("CACertUrl",n)}(t),function(t){let e=window.setTimeout((function(){e=null,window.location.reload(!0)}),100);t&&t!=window.location.href&&(window.location=t),window.onbeforeunload=function(){e&&window.clearTimeout(e),e=null}}(n)}t||(t=function(){}),window.onload=function(){window.onload=null,function(){if(!document.querySelectorAll)return;const t=document.querySelectorAll("[translate]");for(let e=0;e<t.length;e++)t[e].textContent=c(t[e].textContent)}(),window.cockpit_po&&window.cockpit_po[""]&&(document.documentElement.lang=window.cockpit_po[""].language,window.cockpit_po[""]["language-direction"]&&(document.documentElement.dir=window.cockpit_po[""]["language-direction"])),L(window.location.pathname),0!==window.location.pathname.indexOf("/"+o+"/cockpit/")&&0!==window.location.pathname.indexOf("/"+o+"/cockpit+")||document.documentElement.setAttribute("class","inline");let t=i.page.title;if(i.is_cockpit_client&&(t=l("Login")),t&&0!==u.indexOf("cockpit+=")||(t=i.hostname),document.title=t,0===u.indexOf("cockpit+=")?y("#brand","#badge"):(b("badge",""),b("brand","Cockpit")),!C())return;i.banner&&(k("#banner"),h("banner-message").textContent=i.banner.trimEnd()),h("show-other-login-options").addEventListener("click",I),h("show-other-login-options").addEventListener("keypress",I),h("server-clear").addEventListener("click",(function(){const t=h("server-field");t.value="",t.focus()}));const e="explicit"==window.sessionStorage.getItem("logout-intent");e&&window.sessionStorage.removeItem("logout-intent");const n=window.sessionStorage.getItem("logout-reason");n&&window.sessionStorage.removeItem("logout-reason"),s?(y("#login-details","#login"),e?(T(),h("login-again").textContent=l("Login again"),x(l("Logout successful"))):function(){const t=document.createElement("a");if(!s.URL)return x(l("Cockpit authentication is configured incorrectly."));const e=!window.location.search&&window.location.hash?m(window.location.hash.slice(1)):m(window.location.search);if(T(),e[s.TokenParam]){window.sessionStorage.getItem("login-wanted")&&(t.href=window.sessionStorage.getItem("login-wanted"),L(t.pathname));const n=e[s.TokenParam];k("#login-wait-validating");const o=new XMLHttpRequest;o.open("GET",d,!0),o.setRequestHeader("Authorization","Bearer "+n),o.onreadystatechange=function(){if(4==o.readyState)if(200==o.status)B(JSON.parse(o.responseText));else{const t=X(o.getResponseHeader("WWW-Authenticate"),o.responseText);t?M(t):x(decodeURIComponent(o.statusText))}},o.send()}else e[s.ErrorParam]?x(e[s.ErrorParam]):(window.sessionStorage.setItem("login-wanted",window.location.href),window.location=w)}()):e?q(n):U()?q():function(){const t=new XMLHttpRequest;t.open("GET",d,!0),t.onreadystatechange=function(){4==t.readyState&&(200==t.status?B(JSON.parse(t.responseText)):401==t.status?q():t.statusText?x(decodeURIComponent(t.statusText)):0===t.status?q():x(a(l("$0 error"),t.status)))},t.send()}()}}(window.console)})();
\ 文件尾没有换行符
+(function(m){let c;try{c=window.localStorage,window.localStorage.removeItem("url-root"),window.localStorage.removeItem("standard-login")}catch(e){c=window.sessionStorage,m.warn(String(e))}const I=c.getItem("shell:style");window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&I==="auto"||I==="dark"?document.documentElement.classList.add("pf-theme-dark"):document.documentElement.classList.remove("pf-theme-dark"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{e.matches&&I==="auto"||I==="dark"?document.documentElement.classList.add("pf-theme-dark"):document.documentElement.classList.remove("pf-theme-dark")});let p;const l=window.environment||{},g=l.OAuth||null;g&&(g.TokenParam||(g.TokenParam="access_token"),g.ErrorParam||(g.ErrorParam="error_description"));const Y=/\$\{([^}]+)\}|\$([a-zA-Z0-9_]+)/g;function v(e){const t=Array.prototype.slice.call(arguments,1);return e.replace(Y,function(i,n,s){return t[n||s]||""})}function N(e){if(window.cockpit_po){const t=window.cockpit_po[e];if(t&&t[1])return t[1]}return e}function Z(){if(!document.querySelectorAll)return;const e=document.querySelectorAll("[translate]");for(let t=0;t<e.length;t++)e[t].textContent=N(e[t].textContent)}const a=N;let _,w,R,C;const K=/[?&]?([^=]+)=([^&]*)/g;let b=null;function P(e){e=e.split("+").join(" ");const t={};for(;;){const i=K.exec(e);if(!i)break;t[decodeURIComponent(i[1])]=decodeURIComponent(i[2])}return t}m||(m=function(){});function o(e){return document.getElementById(e)}function y(e,t){typeof e=="string"&&(e=[e]);for(let i=0;i<e.length;i++)if(typeof e[i]=="string"){const n=document.querySelectorAll(e[i]);n&&n.forEach(function(s){s.hidden!==!!t&&(s.hidden=!!t)})}else e[i].hidden!==!!t&&(e[i].hidden=!!t)}function d(){y(arguments,!1)}function u(){y(arguments,!0)}function V(e){window.console&&m.warn("stderr:",e),u("#login-wait-validating"),u("#login","#login-details"),d("#login-fatal"),o("login-again").onclick=()=>{u("#login-fatal"),L()},d("#login-again");const t=o("login-fatal-message");t.textContent="",t.appendChild(document.createTextNode(e))}function k(e){window.console&&m.warn("fatal:",e),u("#login-again","#login-wait-validating"),b&&(o("login-again").href=b,d("#login-again")),u("#login","#login-details"),d("#login-fatal");const t=o("login-fatal-message");t.textContent="",t.appendChild(document.createTextNode(e))}function E(e,t){const i=o(e),n=i&&window.getComputedStyle?window.getComputedStyle(i,":before"):null;if(!n)return;let s=n.content;if(s&&s!="none"&&s!="normal"){const r=s.length;(s[0]==='"'||s[0]==="'")&&r>2&&s[r-1]===s[0]&&(s=s.substr(1,r-2)),i.innerHTML=s||t}else i.removeAttribute("class")}function ee(){function e(r){r?(d("#login","#login-details","#login-override"),u("#get-out-link"),o("login-override-content").appendChild(o("login")),o("login-button").classList.add("pf-m-warning"),document.querySelector("#login .login-actions").insertAdjacentHTML("beforebegin","<div class='pf-c-helper-text pf-m-warning' id='bypass-warning'>"+a("Cockpit might not render correctly in your browser")+"</div>")):u("#login","#login-details","#login-override")}function t(r,h){r==="supports"&&(r="@supports API");const x=v(a("This web browser is too old to run the Web Console (missing $0)"),r);window.console&&m.warn(x),o("login-error-message").textContent=x,d("#unsupported-browser","#error-group"),document.body.classList.add("unsupported-browser"),e(h)}function i(r,h){let x;try{x=h&&h[r]}catch(fe){throw k(v(a("The web browser configuration prevents Cockpit from running (inaccessible $0)"),r)),fe}return x===void 0?(t(r),!1):!0}function n(){const r=[].join.call(arguments,": ");return!window.CSS||!window.CSS.supports.apply(this,arguments)?(t(r,"bypass"),!1):!0}return i("WebSocket",window)&&i("XMLHttpRequest",window)&&i("sessionStorage",window)&&i("JSON",window)&&i("defineProperty",Object)&&i("console",window)&&i("pushState",window.history)&&i("textContent",document)&&i("replaceAll",String.prototype)&&i("finally",Promise.prototype)&&i("supports",window.CSS)?(n("display","flex")&&n("display","grid")&&n("selector(test)")&&n("selector(:is(*):where(*))"),!0):!1}function $(e){return e.replace(/^\s+|\s+$/g,"")}function J(e){const t=document.createElement("a"),i=document.baseURI;e=e||"/",t.href=i,t.pathname!="/"&&(p=t.pathname.replace(/^\/+|\/+$/g,""),c.setItem("url-root",p),p&&e.indexOf("/"+p)===0&&(e=e.replace("/"+p,"")||"/")),e.indexOf("/=")===0?(l.hostname=e.substring(2).split("/")[0],o("server-field").value=l.hostname,T(null,!0),e="/cockpit+"+e.split("/")[1]):e.indexOf("/cockpit/")!==0&&e.indexOf("/cockpit+")!==0&&(e="/cockpit"),w=e.split("/")[1],_="/"+w+"/login",p&&(_="/"+p+_),C=w,R=_}function T(e,t){e&&e.type==="keypress"&&e.key!==" "||(e&&e.type==="click"&&e.preventDefault(),t===void 0&&(t=o("server-group").hidden),y("#server-group",!t),o("option-group").setAttribute("data-state",t))}function te(e){const t=o("login-password-input");t.setAttribute("type",t.getAttribute("type")==="password"?"text":"password"),e.stopPropagation()}function ne(){window.onload=null,Z(),window.cockpit_po&&window.cockpit_po[""]&&(document.documentElement.lang=window.cockpit_po[""].language,window.cockpit_po[""]["language-direction"]&&(document.documentElement.dir=window.cockpit_po[""]["language-direction"])),J(window.location.pathname),(window.location.pathname.indexOf("/"+p+"/cockpit/")===0||window.location.pathname.indexOf("/"+p+"/cockpit+")===0)&&document.documentElement.setAttribute("class","inline");let e=l.page.title;if(l.is_cockpit_client&&(e=a("Login")),(!e||w.indexOf("cockpit+=")===0)&&(e=l.hostname),document.title=e,w.indexOf("cockpit+=")===0?u("#brand","#badge"):(E("badge",""),E("brand","Cockpit")),!ee())return;l.banner&&(d("#banner"),o("banner-message").textContent=l.banner.trimEnd()),o("show-other-login-options").addEventListener("click",T),o("show-other-login-options").addEventListener("keypress",T),o("server-clear").addEventListener("click",function(){const n=o("server-field");n.value="",n.focus()});const t=window.sessionStorage.getItem("logout-intent")=="explicit";t&&window.sessionStorage.removeItem("logout-intent");const i=window.sessionStorage.getItem("logout-reason");i&&window.sessionStorage.removeItem("logout-reason"),g?(u("#login-details","#login"),t?(M(),o("login-again").textContent=a("Login again"),k(a("Logout successful"))):ie()):t?L(i):G()?L():oe()}function oe(){const e=new XMLHttpRequest;e.open("GET",_,!0),e.onreadystatechange=function(){e.readyState==4&&(e.status==200?H(JSON.parse(e.responseText)):e.status==401?L():e.statusText?k(decodeURIComponent(e.statusText)):e.status===0?L():k(v(a("$0 error"),e.status)))},e.send()}function M(){const e=window.location.href.split("#",2);b=g.URL,g.URL.indexOf("?")>-1?b+="&":b+="?",b+="redirect_uri="+encodeURIComponent(e[0])}function ie(){const e=document.createElement("a");if(!g.URL)return k(a("Cockpit authentication is configured incorrectly."));const t=!window.location.search&&window.location.hash?P(window.location.hash.slice(1)):P(window.location.search);if(M(),t[g.TokenParam]){window.sessionStorage.getItem("login-wanted")&&(e.href=window.sessionStorage.getItem("login-wanted"),J(e.pathname));const i=t[g.TokenParam];d("#login-wait-validating");const n=new XMLHttpRequest;n.open("GET",_,!0),n.setRequestHeader("Authorization","Bearer "+i),n.onreadystatechange=function(){if(n.readyState==4)if(n.status==200)H(JSON.parse(n.responseText));else{const s=F(n.getResponseHeader("WWW-Authenticate"),n.responseText);s?j(s):k(decodeURIComponent(n.statusText))}},n.send()}else t[g.ErrorParam]?k(t[g.ErrorParam]):(window.sessionStorage.setItem("login-wanted",window.location.href),window.location=b)}function W(){u("#error-group"),o("login-error-message").textContent=""}function X(){u("#info-group"),o("login-info-message").textContent=""}function f(e,t){W(),e&&(g?k(e):(S(t||"login"),o("login-error-message").textContent=e,d("#error-group")))}function se(e){X(),e&&(o("login-info-message").textContent=e,d("#info-group"))}function O(e){o("server-field").value?(W(),o("login-error-message").textContent=e,d("#error-group"),T(null,!0),S("login")):f(e)}function re(e){const t=o("login-note");e?(d(t),t.textContent=e):t.innerHTML="&nbsp;"}function G(){return l.page.require_host&&C.indexOf("cockpit+=")===-1}function z(){let e=[];try{e=JSON.parse(c.getItem("cockpit-client-sessions")||"[]")}catch(t){m.log("Failed to parse 'cockpit-client-sessions':",t)}return e}function A(){f(null);const e=$(o("login-user-input").value);if(e===""&&!l.is_cockpit_client)f(a("User name cannot be empty"));else if(G()&&o("server-field").value==="")f(a("Please specify the host to connect to"));else{const t=o("server-field").value;t?(w="cockpit+="+t,_=R.replace("/"+C+"/","/"+w+"/"),o("brand").style.display="none",o("badge").style.visibility="hidden"):(w=C,_=R,E("badge",""),E("brand","Cockpit")),o("server-name").textContent=t||l.hostname,o("login-button").removeEventListener("click",A);const i=o("login-password-input").value,n="superuser:"+e+(t?":"+t:""),s=c.getItem(n)||"none";c.setItem("superuser-key",n),c.setItem(n,s),c.setItem("standard-login",!0);const r={Authorization:"Basic "+window.btoa(D(e+":"+i)),"X-Superuser":s};t&&(r["X-SSH-Connect-Unknown-Hosts"]="yes"),Q("GET",r,!1)}}function B(){const e=z(),t=o("recent-hosts-list");t.innerHTML="",e.forEach(i=>{const n=document.createElement("div");n.classList.add("host-line");const s=document.createElement("button");s.textContent=i,s.classList.add("pf-c-button","pf-m-tertiary","host-name"),s.addEventListener("click",()=>{o("server-field").value=i,A()});const r=document.createElement("button");r.title=a("Remove host"),r.ariaLabel=r.title,r.classList.add("host-remove"),r.addEventListener("click",()=>{const h=e.indexOf(i);e.splice(h,1),c.setItem("cockpit-client-sessions",JSON.stringify(e)),B()}),n.append(s,r),t.append(n)}),y("#recent-hosts",e.length==0)}function S(e){const t=l.page.connect;let i=o("option-group").getAttribute("data-state");if(u("#login-wait-validating"),d("#login"),y("#login-details",l.is_cockpit_client),y("#server-field-label",l.is_cockpit_client),l.is_cockpit_client){const n=o("brand");n.textContent=a("Connect to:"),n.classList.add("text-brand")}y(["#user-group","#password-group"],e!="login"||l.is_cockpit_client),y("#conversation-group",e!="conversation"),y("#hostkey-group",e!="hostkey"),o("login-button-text").textContent=e=="hostkey"?a("Accept key and log in"):a("Log in"),e!="login"&&(o("login-password-input").value=""),l.page.require_host?(u("#option-group"),i=!0):y("#option-group",!t||e!="login"),!t||e!="login"?u("#server-group"):y("#server-group",!i),o("login-button").removeAttribute("disabled"),o("login-button").removeAttribute("spinning"),o("login-button").classList.remove("pf-m-danger"),o("login-button").classList.add("pf-m-primary"),u("#get-out-link"),e=="login"&&o("login-button").addEventListener("click",A),l.is_cockpit_client&&(B(),document.body.classList.add("cockpit-client"))}function L(e){se(e),o("server-name").textContent=document.title,re(a("Log in with your server user account.")),o("login-user-input").addEventListener("keydown",function(i){f(null),X(),i.which==13&&o("login-password-input").focus()},!1);const t=function(i){f(null),i.which==13&&A()};o("login-password-input").addEventListener("keydown",t),o("login-password-toggle").addEventListener("click",te),S("login"),l.is_cockpit_client?l.page.require_host&&o("server-field").focus():o("login-user-input").focus()}function ae(){try{return JSON.parse(c.getItem("known_hosts")||"{ }")}catch(e){return m.warn("Can't parse known_hosts database in localStorage",e),{}}}function le(e){try{c.setItem("known_hosts",JSON.stringify(e))}catch(t){m.warn("Can't write known_hosts database to localStorage",t)}}function ce(e){const t=ae(),i=e["host-key"],n=i.split(" ")[0],s=i.split(" ")[1];if(t[n]==i){q(e.id,e.default);return}t[n]?(o("hostkey-title").textContent=v(a("$0 key changed"),o("server-field").value),d("#hostkey-warning-group"),o("hostkey-message-1").textContent=""):(o("hostkey-title").textContent=a("New host"),u("#hostkey-warning-group"),o("hostkey-message-1").textContent=v(a("You are connecting to $0 for the first time."),o("server-field").value)),o("hostkey-verify-help-1").textContent=v(a("To verify a fingerprint, run the following on $0 while physically sitting at the machine or through a trusted network:"),o("server-field").value),o("hostkey-verify-help-cmds").textContent=v("ssh-keyscan$0 localhost | ssh-keygen -lf -",s?" -t "+s:""),o("hostkey-fingerprint").textContent=e.default,s?(o("hostkey-type").textContent=v("($0)",s),d("#hostkey-type")):u("#hostkey-type"),f("");function r(){o("login-button").removeEventListener("click",r),f(null,"hostkey"),t[n]=i,le(t),q(e.id,e.default)}o("login-button").addEventListener("click",r),S("hostkey"),d("#get-out-link"),t[n]&&(o("login-button").classList.add("pf-m-danger"),o("login-button").classList.remove("pf-m-primary"))}function j(e){if(e["host-key"]){ce(e);return}const t=e.echo?"text":"password";o("conversation-prompt").textContent=e.prompt;const i=o("conversation-message"),n=e.error||e.message;n?(i.textContent=n,d(i)):u(i);const s=o("conversation-input");s.value="",e.default&&(s.value=e.default),s.setAttribute("type",t),f("");function r(){o("conversation-input").removeEventListener("keydown",h),o("login-button").removeEventListener("click",r),f(null,"conversation"),q(e.id,o("conversation-input").value)}function h(x){f(null,"conversation"),x.which==13&&r()}o("conversation-input").addEventListener("keydown",h),o("login-button").addEventListener("click",r),S("conversation"),s.focus()}function D(e){return window.unescape(encodeURIComponent(e))}function F(e,t){if(!e)return null;const i=e.split(" ");if(i[0].toLowerCase()!=="x-conversation"&&i.length!=3)return null;const n=i[1];let s;try{s=window.atob(i[2])}catch(h){return window.console&&m.error("Invalid prompt data",h),null}let r;try{r=JSON.parse(t)}catch(h){window.console&&m.log("Got invalid JSON response for prompt data",h),r={}}return r.id=n,r.prompt=s,r}function Q(e,t,i){o("login-button").setAttribute("disabled","true"),o("login-button").setAttribute("spinning","true");const n=new XMLHttpRequest;n.open(e,_,!0);for(const s in t)n.setRequestHeader(s,t[s]);n.onreadystatechange=function(){if(n.readyState==4)if(n.status==200){const s=JSON.parse(n.responseText);H(s)}else if(n.status==401){const s=n.getResponseHeader("WWW-Authenticate");if(s&&s.toLowerCase().indexOf("x-conversation")===0){const r=F(s,n.responseText);r?j(r):k(a("Internal error: Invalid challenge header"))}else if(window.console&&m.log(n.statusText),n.statusText.startsWith("captured-stderr:"))V(decodeURIComponent(n.statusText.replace(/^captured-stderr:/,"")));else if(n.statusText.indexOf("authentication-not-supported")>-1){const r=$(o("login-user-input").value);k(v(a("The server refused to authenticate '$0' using password authentication, and no other supported authentication methods are available."),r))}else n.statusText.indexOf("terminated")>-1?f(a("Authentication failed: Server closed connection")):n.statusText.indexOf("no-host")>-1?O(a("Unable to connect to that address")):n.statusText.indexOf("unknown-hostkey")>-1?O(a("Refusing to connect. Hostkey is unknown")):n.statusText.indexOf("unknown-host")>-1?O(a("Refusing to connect. Host is unknown")):n.statusText.indexOf("invalid-hostkey")>-1?O(a("Refusing to connect. Hostkey does not match")):f(a(i?"Authentication failed":"Wrong user name or password"))}else n.status==403?f(a(decodeURIComponent(n.statusText))||a("Permission denied")):n.statusText?k(decodeURIComponent(n.statusText)):k(v(a("$0 error"),n.status))},n.send()}function q(e,t){const i={Authorization:"X-Conversation "+e+" "+window.btoa(D(t))};Q("GET",i,!0)}function ue(e){let t=window.setTimeout(function(){t=null,window.location.reload(!0)},100);e&&e!=window.location.href&&(window.location=e),window.onbeforeunload=function(){t&&window.clearTimeout(t),t=null}}function U(e,t,i){let n=0;for(;n<e.length;){const s=e.key(n);i&&s.indexOf("cockpit")!==0||s.indexOf(t)===0?e.removeItem(s):n++}}function de(e){if(U(window.sessionStorage,w,!0),c.removeItem("login-data"),U(c,w,!1),e&&e["login-data"]){const i=JSON.stringify(e["login-data"]);c.setItem(w+"login-data",i),c.setItem("login-data",i)}p&&c.setItem("url-root",p);const t=l.CACertUrl;t&&window.sessionStorage.setItem("CACertUrl",t)}function H(e){let t=window.sessionStorage.getItem("login-wanted");const i=o("server-field").value;if(i&&l.is_cockpit_client){const n=z();n.indexOf(i)<0&&(n.push(i),c.setItem("cockpit-client-sessions",JSON.stringify(n)))}i&&w!=C&&(t="/="+i,p&&(t="/"+p+t)),U(window.sessionStorage,w,!1),de(e),ue(t)}ne()})(window.console);
