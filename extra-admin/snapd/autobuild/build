declare -A ARCH_MAP;
ARCH_DEF=$(dpkg --print-architecture)
ARCH_MAP=( ["amd64"]="64" ["armel"]="arm" ["arm64"]="arm64" ["mipsel"]="mipsle" ["mips64el"]="mips64le")
GO_ARCH=${ARCH_MAP["$ARCH_DEF"]}

export GOPATH="${SRCDIR}/build"
export GOURL="github.com/snapcore/snapd"

mkdir -p "$GOPATH"
mkdir -p "$GOPATH"/src/"$GOURL"
rm -d $GOPATH/src/"$GOURL"
ln --no-target-directory -fs "$SRCDIR" "$GOPATH"/src/"$GOURL"

export CGO_ENABLED="1"
#export CGO_CFLAGS="$CFLAGS"
#export CGO_CPPFLAGS="$CPPFLAGS"
#export CGO_CXXFLAGS="$CXXFLAGS"
#export CGO_LDFLAGS="$LDFLAGS"

./mkversion.sh $PKGVER-$PKGREL

#FLAGS="-buildmode=pie -ldflags='-extldflags=\'$LDFLAGS\''"
#STATICFLAGS="-buildmode=pie -ldflags='-extldflags=\'$LDFLAGS -static\'"

go build $FLAGS -o "$GOPATH"/bin/snap "$GOURL"/cmd/snap
go build $FLAGS -o "$GOPATH"/bin/snapctl "$GOURL"/cmd/snapctl
go build $FLAGS -o "$GOPATH"/bin/snapd "$GOURL"/cmd/snapd
go build $FLAGS -o "$GOPATH"/bin/snap-seccomp "$GOURL"/cmd/snap-seccomp
go build $FLAGS -o "$GOPATH"/bin/snap-failure "$GOURL"/cmd/snap-failure
go build $STATICFLAGS -o "$GOPATH"/bin/snap-update-ns "$GOURL"/cmd/snap-update-ns
go build $STATICFLAGS -o "$GOPATH"/bin/snap-exec "$GOURL"/cmd/snap-exec

make -C data \
	BINDIR=/usr/bin \
	LIBEXECDIR=/usr/lib \
	SYSTEMDSYSTEMUNITDIR=/usr/lib/systemd/system \
	SNAP_MOUNT_DIR=/var/lib/snapd/snap \
	SNAPD_ENVIRONMENT_FILE=/etc/default/snapd

cd cmd
autoreconf -i -f
./configure \
	--prefix=/usr \
	--libexecdir=/usr/lib/snapd \
	--with-snap-mount-dir=/var/lib/snapd/snap \
	--disable-apparmor \
	--enable-nvidia-biarch \
	--enable-merged-usr
make $MAKEFLAGS

cd $SRCDIR
install -Dvm644 data/completion/snap "$PKGDIR"/usr/share/bash-completion/completions/snap
install -Dvm644 data/completion/complete.sh "$PKGDIR"/usr/lib/snapd/complete.sh
install -Dvm644 data/completion/etelpmoc.sh "$PKGIDR"/usr/lib/snapd/etelpmoc.sh

# Systemd units, dbus services, script for env vars
make -C data/ install \
	DBUSSERVICEDIR=/usr/share/dbus-1/services \
	BINDIR=/usr/bin \
	SYSTEMDSYSTEMUNITDIR=/usr/lib/systemd/system \
	SNAP_MOUNT_DIR=/var/lib/snapd/snap \
	DESTDIR="$PKGDIR"

# Polkit policy
install -Dvm644 data/polkit/io.snapcraft.snapd.policy "$PKGDIR"/usr/share/polkit-1/actions/io.snapcraft.snapd.policy

# Executables
install -Dvm755 "$GOPATH"/bin/snap "$PKGDIR"/usr/bin/snap
install -Dvm755 "$GOPATH"/bin/snapctl "$PKGDIR"/usr/bin/snapctl
install -Dvm755 "$GOPATH"/bin/snapd "$PKGDIR"/usr/lib/snapd/snapd
install -Dvm755 "$GOPATH"/bin/snap-seccomp "$PKGDIR"/usr/lib/snapd/snap-seccomp
install -Dvm755 "$GOPATH"/bin/snap-failure "$PKGDIR"/usr/lib/snapd/snap-failure
install -Dvm755 "$GOPATH"/bin/snap-update-ns "$PKGDIR"/usr/lib/snapd/snap-update-ns
install -Dvm755 "$GOPATH"/bin/snap-exec "$PKGDIR"/usr/lib/snapd/snap-exec

# Pre-create directories
install -dvm755 "$PKGDIR"/var/lib/snapd/snap
install -dvm755 "$PKGDIR"/var/cache/snapd
install -dvm755 "$PKGDIR"/var/lib/snapd/apparmor
install -dvm755 "$PKGDIR"/var/lib/snapd/assertions
install -dvm755 "$PKGDIR"/var/lib/snapd/desktop/applications
install -dvm755 "$PKGDIR"/var/lib/snapd/device
install -dvm755 "$PKGDIR"/var/lib/snapd/hostfs
install -dvm755 "$PKGDIR"/var/lib/snapd/mount
install -dvm755 "$PKGDIR"/var/lib/snapd/seccomp/bpf
install -dvm755 "$PKGDIR"/var/lib/snapd/snap/bin
install -dvm755 "$PKGDIR"/var/lib/snapd/snaps
install -dvm755 "$PKGDIR"/var/lib/snapd/lib/gl
install -dvm755 "$PKGDIR"/var/lib/snapd/lib/gl32
install -dvm755 "$PKGDIR"/var/lib/snapd/lib/vulkan
install -dvm755 "$PKGDIR"/var/lib/snapd/lib/glvnd

# Dirs with special permissions
install -dvm000 "$PKGDIR"/var/lib/snapd/void
install -dvm700 "$PKGDIR"/var/lib/snapd/cookie
install -dvm700 "$PKGDIR"/var/lib/snapd/cache

make -C cmd install DESTDIR="$PKGDIR"/

# Man
install -dvm755 "$PKGDIR"/usr/share/man/man1
"$GOPATH"/bin/snap help --man > "$PKGIDR"/usr/share/man/man1/snap.1

# Info data
install -Dvm644 "$GOPATH"/src/$GOURL/data/info "$PKGDIR"/usr/lib/snapd/info

# Remove snappy core files
rm -fv "$PKGDIR"/usr/lib/systemd/system/snapd.system-shutdown.service
rm -fv "$PKGDIR"/usr/lib/systemd/system/snapd.autoimport.service
rm -fv "$PKGDIR"/usr/lib/systemd/system/snapd.snap-repair.*
rm -fv "$PKGDIR"/usr/lib/systemd/system/snapd.core-fixup.*

# And scripts
rm -fv "$PKGDIR"/usr/lib/snapd/snapd.core-fixup.sh
rm -fv "$PKGDIR"/usr/bin/ubuntu-core-launcher
rm -fv "$PKGDIR"/usr/lib/snapd/system-shutdown
