APM_VERSION=2.6.3

abinfo "Extracting Atom ..."
dpkg -x "$SRCDIR"/atom-amd64.deb \
    "$SRCDIR"

abinfo "Building apm..."
pushd "$SRCDIR"/apm-${APM_VERSION}

for i in "$SRCDIR"/autobuild/apm_patches/*; do
    abinfo "Applying $i for apm ..."
    patch -Np1 -i "$i"
done

abinfo "Building apm with Yarn ..."
yarn install
yarn build

abinfo "Taking out trash..."
find "$(pwd)" \
    -name ".*" -prune -exec rm -v -r '{}' \; \
    -or -name "*.a" -exec rm -v '{}' \; \
    -or -name "*.bat" -exec rm -v '{}' \; \
    -or -name "*.mk" -exec rm -v '{}' \; \
    -or -path "*/git-utils/binding.gyp" -exec rm -v '{}' \; \
    -or -path "*/git-utils/src/*.cc" -prune -exec rm -v -r '{}' \; \
    -or -path "*/keytar/binding.gyp" -exec rm -v '{}' \; \
    -or -path "*/keytar/src" -prune -exec rm -v -r '{}' \; \
    -or -path "*/oniguruma/binding.gyp" -exec rm -v '{}' \; \
    -or -path "*/oniguruma/src/*.cc" -prune -exec rm -v -r '{}' \; \
    -or -name "appveyor.yml" -exec rm -v '{}' \; \
    -or -name "benchmark" -prune -exec rm -v -r '{}' \; \
    -or -name "binding.Makefile" -exec rm -v '{}' \; \
    -or -name "config.gypi" -exec rm -v '{}' \; \
    -or -name "deps" -prune -exec rm -v -r '{}' \; \
    -or -name "doc" -prune -exec rm -v -r '{}' \; \
    -or -name "html" -prune -exec rm -v -r '{}' \; \
    -or -name "Makefile" -exec rm -v '{}' \; \
    -or -name "man" -prune -exec rm -v -r '{}' \; \
    -or -name "obj.target" -prune -exec rm -v -r '{}' \; \
    -or -name "samples" -prune -exec rm -v -r '{}' \; \
    -or -name "test" -prune -exec rm -v -r '{}' \; \
    -or -name "tests" -prune -exec rm -v -r '{}' \; \
    -or -name "*.md" -prune -exec rm -v -r '{}' \;
popd

abinfo "Copying built apm into target directory..."
rm -rfv "$SRCDIR"/usr/share/atom/resources/app/apm/*
cp -arv "$SRCDIR"/apm-${APM_VERSION}/* \
    "$SRCDIR"/usr/share/atom/resources/app/apm/

abinfo "Tweaking .desktop entry ..."
sed -e 's|env PYTHON=python2 GTK_IM_MODULE= QT_IM_MODULE= XMODIFIERS= /usr/share/atom/atom|/usr/bin/atom|' \
    -i "$SRCDIR"/usr/share/applications/atom.desktop

abinfo "Dropping SUID bit from usr ..."
chmod -vR g-w "$SRCDIR"/usr

abinfo "Installing binpacked files ..."
mkdir -pv "$PKGDIR"
cp -arv "$SRCDIR"/usr \
    "$PKGDIR"/

abinfo "Symlinking apm ..."
rm -v "$PKGDIR"/usr/bin/apm
ln -sv ../share/atom/resources/app/apm/bin/apm \
    "$PKGDIR"/usr/bin/apm
