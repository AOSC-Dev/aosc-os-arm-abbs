if   [[ "${CROSS:-$ARCH}" = "amd64" ]]; then
    ARCH_OPTS="x86_64"
elif [[ "${CROSS:-$ARCH}" = "arm64" ]]; then
    ARCH_OPTS="aarch64"
fi

lazbuild \
  --lazarusdir=/usr/share/lazarus \
  --cpu=${ARCH_OPTS} \
  --widgetset=gtk2 \
  --max-process-count=$(nproc --all) \
  -B project_pea.lpi project_peach.lpi

mkdir "${PKGDIR}/usr/bin" -p
mkdir "${PKGDIR}/usr/lib/peazip/res" -p
mkdir "${PKGDIR}/usr/share/pixmaps" -p
mkdir "${PKGDIR}/usr/share/doc/peazip" -p
mkdir "${PKGDIR}/usr/share/applications" -p
mkdir "${PKGDIR}/usr/share/kservices5/ServiceMenus" -p

install -m755 "${SRCDIR}/peazip" "${PKGDIR}/usr/lib/peazip/peazip"
install -m755 "${SRCDIR}/pea" "${PKGDIR}/usr/lib/peazip/pea"
install -m644 "${SRCDIR}/../peazip_help-7.7.0.pdf" "${PKGDIR}/usr/share/doc/peazip/peazip_help.pdf"
install -m644 "${SRCDIR}/FreeDesktop_integration/peazip.png" "${PKGDIR}/usr/share/pixmaps/peazip.png"
install -m644 "${SRCDIR}/FreeDesktop_integration/peazip.desktop" "${PKGDIR}/usr/share/applications/peazip.desktop"

pushd "${SRCDIR}/FreeDesktop_integration/kde4-dolphin/usr/share/kde4/services/ServiceMenus"
install -m644 *.desktop "${PKGDIR}/usr/share/kservices5/ServiceMenus"
popd

pushd "${PKGDIR}/usr/bin"
ln -s ../lib/peazip/peazip ./peazip
ln -s ../lib/peazip/pea ./pea
popd

pushd "${PKGDIR}/usr/lib/peazip"
for i in 7z brotli zpaq zstd upx
do
  mkdir "${PKGDIR}/usr/lib/peazip/res/$i"
  ln -s ../../../../bin/$i ./res/$i/$i
done
popd
