name: Build package on request

on:
  issue_comment:
    types: [created, edited]

jobs:
  build:
    if: ${{ github.event.issue.pull_request && contains(github.event.comment.body, '/build ') }}
    runs-on: ubuntu-latest
    container: aosc/aosc-os-buildkit:latest

    steps:
      # https://github.com/dotnet/runtime/blob/main/.github/workflows/backport.yml
      - name: Get the package to build
        uses: actions/github-script@v5
        id: get-package
        with:
          script: |
            const regex = /\/build ([a-z\d\/\.\-]+)/;
            package = regex.exec(context.payload.comment.body);
            if (package == null) throw "No package found in the command!";
            return package[1];
          result-encoding: string

      - uses: actions/checkout@v2
      
      - name: Install GitHub CLI
        working-directory: ${{env.GITHUB_WORKSPACE}}
        env:
          GH_VERSION: 2.0.0
          GH_ARCH: amd64
        run: |
          curl -LO https://github.com/cli/cli/releases/download/v${{env.GH_VERSION}}/gh_${{env.GH_VERSION}}_linux_${{env.GH_ARCH}}.tar.gz
          tar -xf gh_${{env.GH_VERSION}}_linux_${{env.GH_ARCH}}.tar.gz
          ln -s ${PWD}gh_${{env.GH_VERSION}}_linux_${{env.GH_ARCH}}/bin/gh /usr/bin/gh

      - name: Prepare for building the package
        working-directory: ${{env.GITHUB_WORKSPACE}}
        env:
          PR_NUMBER: ${{github.event.issue.number}}
        run: |
          gh pr checkout ${{env.PR_NUMBER}}
          mkdir -p /var/lib/acbs
          ln -s $PWD /var/lib/acbs/repo
          sed -i 's/Null Packager <null@aosc.xyz>/GitHub Actions <discussions@lists.aosc.io>/' /etc/autobuild/ab3cfg.sh

      - name: Build the package
        working-directory: ${{env.GITHUB_WORKSPACE}}
        env:
          PACKAGE: ${{steps.get-package.outputs.result}}
        run: script -eqc "acbs-build \"${{env.PACKAGE}}\""

      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: Packages
          path: /debs
